<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:NAVIGEST.macOS.PageModels"
             xmlns:res="clr-namespace:NAVIGEST.Shared.Resources.Strings;assembly=NAVIGEST.Shared"
             x:Class="NAVIGEST.macOS.Pages.DashboardPage"
             x:DataType="{x:Null}"
             BackgroundColor="{DynamicResource BodyBg}">
    <ContentPage.Resources>
        <Style TargetType="Border" x:Key="Card">
            <Setter Property="StrokeShape">
                <Setter.Value>
                    <RoundRectangle CornerRadius="14" />
                </Setter.Value>
            </Setter>
            <Setter Property="Stroke" Value="{DynamicResource CardBorder}" />
            <Setter Property="StrokeThickness" Value="1" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="BackgroundColor" Value="{DynamicResource CardBg}" />
        </Style>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="24,18,24,32" Spacing="18">
            <!-- Header with selectors -->
            <VerticalStackLayout Spacing="12">
                <VerticalStackLayout Spacing="4">
                    <Label Text="{x:Static res:AppResources.Dashboard_Title}" FontSize="24" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                    <Label Text="{x:Static res:AppResources.Dashboard_Subtitle}" FontSize="14" TextColor="{DynamicResource TextSub}" />
                    <Label Text="{Binding HeaderSubtitle}" FontSize="12" TextColor="{DynamicResource TextSub}" />
                </VerticalStackLayout>

                <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                    <Border Padding="12,8" BackgroundColor="{DynamicResource CardBg}" Stroke="{DynamicResource CardBorder}" StrokeThickness="1">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12" />
                        </Border.StrokeShape>
                        <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                            <Button Text="◀" Command="{Binding DecreaseYearCommand}" WidthRequest="36" HeightRequest="32" BackgroundColor="Transparent" TextColor="{DynamicResource TextMain}" FontAttributes="Bold" />
                            <Label Text="{Binding SelectedYear}" FontSize="18" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                            <Button Text="▶" Command="{Binding IncreaseYearCommand}" WidthRequest="36" HeightRequest="32" BackgroundColor="Transparent" TextColor="{DynamicResource TextMain}" FontAttributes="Bold" />
                        </HorizontalStackLayout>
                    </Border>

                    <Border BackgroundColor="{DynamicResource CardBg}" Stroke="{DynamicResource CardBorder}" StrokeThickness="1" Padding="10,6">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12" />
                        </Border.StrokeShape>
                        <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                            <Label Text="{Binding CompareYearLabel}" TextColor="{DynamicResource TextSub}" FontSize="12" />
                            <Switch IsToggled="{Binding ComparePreviousYear}" ThumbColor="{DynamicResource AccentBlue}" OnColor="{DynamicResource AccentBlue}" />
                        </HorizontalStackLayout>
                    </Border>
                    <CollectionView ItemsSource="{Binding AnnualTotals}" ItemsLayout="HorizontalList" SelectionMode="None" HeightRequest="56" HorizontalOptions="EndAndExpand">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="10,8" BackgroundColor="{DynamicResource CardBg}" Stroke="{DynamicResource CardBorder}" StrokeThickness="1" MinimumWidthRequest="140">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12" />
                                    </Border.StrokeShape>
                                    <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                                        <BoxView WidthRequest="6" HeightRequest="26" Color="{Binding Color}" CornerRadius="3" />
                                        <VerticalStackLayout Spacing="2">
                                            <Label Text="{Binding Title}" FontSize="12" TextColor="{DynamicResource TextSub}" />
                                            <Label Text="{Binding Value}" FontSize="16" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                                        </VerticalStackLayout>
                                    </HorizontalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </HorizontalStackLayout>

                <CollectionView x:Name="MonthList"
                                ItemsSource="{Binding MonthOptions}"
                                SelectionMode="None"
                                ItemsLayout="HorizontalList"
                                HeightRequest="58"
                                HorizontalScrollBarVisibility="Never">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout ItemSpacing="10" Orientation="Horizontal" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border x:Name="MonthChip"
                                    Padding="12,10"
                                    BackgroundColor="{DynamicResource CardBgMuted}"
                                    StrokeThickness="0"
                                    VerticalOptions="Center">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={x:Reference MonthList}, Path=BindingContext.SelectMonthCommand}"
                                                          CommandParameter="{Binding Index}" />
                                </Border.GestureRecognizers>
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                        <Setter Property="BackgroundColor" Value="{DynamicResource AccentBlue}" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="False">
                                        <Setter Property="BackgroundColor" Value="{DynamicResource CardBgMuted}" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Label x:Name="MonthLabel"
                                       Text="{Binding Label}"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource TextMain}"
                                       HorizontalTextAlignment="Center">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsSelected}" Value="True">
                                            <Setter Property="TextColor" Value="{DynamicResource White}" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsSelected}" Value="False">
                                            <Setter Property="TextColor" Value="{DynamicResource TextMain}" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroupList>
                                        <VisualStateGroup x:Name="PointerStates">
                                            <VisualState x:Name="Normal" />
                                            <VisualState x:Name="PointerOver">
                                                <VisualState.Setters>
                                                    <Setter TargetName="MonthChip" Property="BackgroundColor" Value="{DynamicResource AccentBlue}" />
                                                    <Setter TargetName="MonthLabel" Property="Label.TextColor" Value="{DynamicResource White}" />
                                                </VisualState.Setters>
                                            </VisualState>
                                            <VisualState x:Name="Pressed">
                                                <VisualState.Setters>
                                                    <Setter TargetName="MonthChip" Property="BackgroundColor" Value="{DynamicResource AccentBlue}" />
                                                    <Setter TargetName="MonthLabel" Property="Label.TextColor" Value="{DynamicResource White}" />
                                                </VisualState.Setters>
                                            </VisualState>
                                            <VisualState x:Name="Focused">
                                                <VisualState.Setters>
                                                    <Setter TargetName="MonthChip" Property="BackgroundColor" Value="{DynamicResource AccentBlue}" />
                                                    <Setter TargetName="MonthLabel" Property="Label.TextColor" Value="{DynamicResource White}" />
                                                </VisualState.Setters>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateGroupList>
                                </VisualStateManager.VisualStateGroups>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

            <!-- Summary cards -->
            <CollectionView ItemsSource="{Binding SummaryCards}" ItemsLayout="HorizontalList" SelectionMode="None" HeightRequest="150">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout ItemSpacing="14" Orientation="Horizontal" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource Card}" WidthRequest="240" BackgroundColor="{DynamicResource CardBg}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="10">
                                <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                    <BoxView WidthRequest="8" HeightRequest="36" CornerRadius="6" Color="{DynamicResource AccentBlue}" />
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding Title}" FontSize="14" TextColor="{DynamicResource TextSub}" />
                                        <Label Text="{Binding Value}" FontSize="26" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                                    </VerticalStackLayout>
                                </HorizontalStackLayout>
                                <Label x:Name="DetailLabel" Text="{Binding Detail}" FontSize="12" TextColor="{DynamicResource TextSub}">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsPositive}" Value="True">
                                            <Setter Property="TextColor" Value="{DynamicResource AccentGreen}" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsPositive}" Value="False">
                                            <Setter Property="TextColor" Value="{DynamicResource AccentRed}" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Charts -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                <Border Style="{StaticResource Card}">
                    <VerticalStackLayout Spacing="12">
                        <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                            <VerticalStackLayout Spacing="2">
                                <Label Text="{x:Static res:AppResources.Dashboard_Chart_RevenueVsExpenses_Title}" FontSize="16" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                                <Label Text="{x:Static res:AppResources.Dashboard_Chart_RevenueVsExpenses_Subtitle}" FontSize="12" TextColor="{DynamicResource TextSub}" />
                            </VerticalStackLayout>
                            <HorizontalStackLayout Grid.Column="1" Spacing="12" VerticalOptions="Center">
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Ellipse WidthRequest="10" HeightRequest="10" Fill="{DynamicResource AccentBlue}" />
                                    <Label Text="{x:Static res:AppResources.Dashboard_Legend_Revenue}" FontSize="11" TextColor="{DynamicResource TextSub}" />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                                    <Ellipse WidthRequest="10" HeightRequest="10" Fill="{DynamicResource AccentRed}" />
                                    <Label Text="{x:Static res:AppResources.Dashboard_Legend_Expenses}" FontSize="11" TextColor="{DynamicResource TextSub}" />
                                </HorizontalStackLayout>
                            </HorizontalStackLayout>
                        </Grid>

                        <Grid HeightRequest="240">
                            <BoxView HeightRequest="1" Color="{DynamicResource CardBorder}" VerticalOptions="End" />
                            <CollectionView ItemsSource="{Binding RevenueVsCost}" ItemsLayout="HorizontalList" SelectionMode="None" HeightRequest="220">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout ItemSpacing="12" Orientation="Horizontal" />
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid HeightRequest="220" WidthRequest="80" Padding="4,0">
                                            <Grid RowDefinitions="*,Auto,Auto" RowSpacing="6">
                                                <Grid Grid.Row="0" ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="6" VerticalOptions="End" HeightRequest="180">
                                                    <Border BackgroundColor="{DynamicResource AccentBlue}" StrokeThickness="0" WidthRequest="20" HeightRequest="{Binding Height}" VerticalOptions="End" />
                                                    <Border Grid.Column="1" BackgroundColor="{DynamicResource AccentRed}" StrokeThickness="0" WidthRequest="20" HeightRequest="{Binding SecondaryHeight}" VerticalOptions="End" />
                                                    <Border Grid.Column="2" BackgroundColor="{DynamicResource AccentCyan}" StrokeThickness="0" WidthRequest="8" HeightRequest="{Binding PrevHeight}" VerticalOptions="End" />
                                                </Grid>
                                                <Label Grid.Row="1" Text="{Binding Display}" FontSize="11" HorizontalTextAlignment="Center" TextColor="{DynamicResource TextSub}" />
                                                <Label Grid.Row="2" Text="{Binding Label}" FontSize="12" HorizontalTextAlignment="Center" TextColor="{DynamicResource TextMain}" />
                                            </Grid>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <Border Grid.Column="1" Style="{StaticResource Card}">
                    <VerticalStackLayout Spacing="12">
                        <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                            <VerticalStackLayout Spacing="2">
                                <Label Text="{x:Static res:AppResources.Dashboard_Chart_CashFlow_Title}" FontSize="16" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                                <Label Text="{x:Static res:AppResources.Dashboard_Chart_CashFlow_Subtitle}" FontSize="12" TextColor="{DynamicResource TextSub}" />
                            </VerticalStackLayout>
                            <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                                <Ellipse WidthRequest="10" HeightRequest="10" Fill="{DynamicResource AccentGreen}" />
                                <Label Text="{x:Static res:AppResources.Dashboard_Legend_Positive}" FontSize="11" TextColor="{DynamicResource TextSub}" />
                                <Ellipse WidthRequest="10" HeightRequest="10" Fill="{DynamicResource AccentRed}" />
                                <Label Text="{x:Static res:AppResources.Dashboard_Legend_Negative}" FontSize="11" TextColor="{DynamicResource TextSub}" />
                            </HorizontalStackLayout>
                        </Grid>

                        <Grid HeightRequest="240">
                            <BoxView HeightRequest="1" Color="{DynamicResource CardBorder}" VerticalOptions="End" />
                            <CollectionView ItemsSource="{Binding CashFlow}" ItemsLayout="HorizontalList" SelectionMode="None" HeightRequest="220">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout ItemSpacing="12" Orientation="Horizontal" />
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid HeightRequest="220" WidthRequest="80" Padding="4,0">
                                            <Grid RowDefinitions="*,Auto,Auto" RowSpacing="6">
                                                <Border x:Name="CashBar" Grid.Row="0" BackgroundColor="{DynamicResource AccentGreen}" StrokeThickness="0" WidthRequest="26" HeightRequest="{Binding Height}" VerticalOptions="End">
                                                    <Border.Triggers>
                                                        <DataTrigger TargetType="Border" Binding="{Binding IsNegative}" Value="True">
                                                            <Setter Property="BackgroundColor" Value="{DynamicResource AccentRed}" />
                                                        </DataTrigger>
                                                    </Border.Triggers>
                                                </Border>
                                                <Label Grid.Row="1" Text="{Binding Display}" FontSize="11" HorizontalTextAlignment="Center" TextColor="{DynamicResource TextSub}" />
                                                <Label Grid.Row="2" Text="{Binding Label}" FontSize="12" HorizontalTextAlignment="Center" TextColor="{DynamicResource TextMain}" />
                                            </Grid>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Grid>
                    </VerticalStackLayout>
                </Border>
            </Grid>

            <!-- Tops -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                <Border Style="{StaticResource Card}">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="{x:Static res:AppResources.Dashboard_TopClients_Title}" FontSize="16" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                        <CollectionView ItemsSource="{Binding TopClients}" SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="*,Auto" Padding="0,4">
                                        <Label Text="{Binding Name}" TextColor="{DynamicResource TextMain}" />
                                        <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                                            <Label Text="{Binding Value}" TextColor="{DynamicResource TextMain}" FontAttributes="Bold" />
                                            <Border HeightRequest="8" WidthRequest="72" BackgroundColor="{DynamicResource CardBgMuted}">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="4" />
                                                </Border.StrokeShape>
                                                <BoxView HorizontalOptions="Start" Color="{DynamicResource AccentBlue}" WidthRequest="{Binding Percent}" HeightRequest="8" CornerRadius="4" />
                                            </Border>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <Border Grid.Column="1" Style="{StaticResource Card}">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="{x:Static res:AppResources.Dashboard_TopProducts_Title}" FontSize="16" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                        <CollectionView ItemsSource="{Binding TopProducts}" SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="*,Auto" Padding="0,4">
                                        <Label Text="{Binding Name}" TextColor="{DynamicResource TextMain}" />
                                        <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                                            <Label Text="{Binding Value}" TextColor="{DynamicResource TextMain}" FontAttributes="Bold" />
                                            <Border HeightRequest="8" WidthRequest="72" BackgroundColor="{DynamicResource CardBgMuted}">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="4" />
                                                </Border.StrokeShape>
                                                <BoxView HorizontalOptions="Start" Color="{DynamicResource AccentGreen}" WidthRequest="{Binding Percent}" HeightRequest="8" CornerRadius="4" />
                                            </Border>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>
            </Grid>

            <Border Style="{StaticResource Card}">
                <VerticalStackLayout Spacing="10">
                    <Label Text="{x:Static res:AppResources.Dashboard_SellerSales_Title}" FontSize="16" FontAttributes="Bold" TextColor="{DynamicResource TextMain}" />
                    <CollectionView ItemsSource="{Binding TopSellers}" ItemsLayout="VerticalList" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="*,Auto" Padding="0,4">
                                    <Label Text="{Binding Name}" TextColor="{DynamicResource TextMain}" />
                                    <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
                                        <Label Text="{Binding Value}" TextColor="{DynamicResource TextMain}" FontAttributes="Bold" />
                                        <Border HeightRequest="8" WidthRequest="72" BackgroundColor="{DynamicResource CardBgMuted}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="4" />
                                            </Border.StrokeShape>
                                            <BoxView HorizontalOptions="Start" Color="{DynamicResource AccentOrange}" WidthRequest="{Binding Percent}" HeightRequest="8" CornerRadius="4" />
                                        </Border>
                                    </HorizontalStackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
