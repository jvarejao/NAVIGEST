<?xml version="1.0" encoding="utf-8"?>
<ContentPage x:Class="NAVIGEST.macOS.Pages.ProductsPage"
             x:Name="ProductsPageRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:NAVIGEST.macOS.Models"
             xmlns:viewmodels="clr-namespace:NAVIGEST.macOS.PageModels"
             xmlns:behaviors="clr-namespace:NAVIGEST.macOS.Behaviors"
             xmlns:strings="clr-namespace:NAVIGEST.macOS.Resources.Strings"
             BackgroundColor="{DynamicResource PageBackgroundColor}"
             Title="{x:Static strings:AppResources.ProductsPage_Title}">

    <ContentPage.Resources>
        <Style TargetType="Button" x:Key="BtnBase">
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="HeightRequest" Value="46"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="TextColor" Value="White"/>
            <Setter Property="Padding" Value="14,8"/>
        </Style>
        <Style TargetType="Button" x:Key="BtnSuccess" BasedOn="{StaticResource BtnBase}"><Setter Property="BackgroundColor" Value="#10B981"/></Style>
        <Style TargetType="Button" x:Key="BtnWarn" BasedOn="{StaticResource BtnBase}"><Setter Property="BackgroundColor" Value="#F59E0B"/></Style>
        <Style TargetType="Button" x:Key="BtnDanger" BasedOn="{StaticResource BtnBase}"><Setter Property="BackgroundColor" Value="#EF4444"/></Style>
        <Style TargetType="Button" x:Key="BtnNeutral" BasedOn="{StaticResource BtnBase}"><Setter Property="BackgroundColor" Value="#6B7280"/></Style>
        <Style TargetType="Entry" x:Key="FormEntry">
            <Setter Property="HeightRequest" Value="44"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
        </Style>
        <Style TargetType="Picker" x:Key="FormPicker">
            <Setter Property="HeightRequest" Value="70"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
            <Setter Property="HorizontalOptions" Value="Fill"/>
            <Setter Property="VerticalOptions" Value="Center"/>
            <Setter Property="TitleColor" Value="{AppThemeBinding Light=#6B7280, Dark=#CBD5E1}"/>
        </Style>
    </ContentPage.Resources>

    <Grid>
        <!-- MAIN CONTENT -->
        <Grid RowDefinitions="Auto, *" 
              Padding="24,24,24,0" 
              RowSpacing="16"
              MaximumWidthRequest="1200"
              HorizontalOptions="Center">
            
            <!-- HEADER: Search & Add -->
            <Grid ColumnDefinitions="*, Auto" ColumnSpacing="16">
                <!-- Search -->
                <Border StrokeShape="RoundRectangle 10" 
                        BackgroundColor="{DynamicResource CardBackgroundColor}"
                        StrokeThickness="0"
                        Padding="8,0"
                        HeightRequest="44"
                        VerticalOptions="Center">
                    <Grid ColumnDefinitions="*,Auto">
                        <Entry Placeholder="{x:Static strings:AppResources.ProductsPage_SearchPlaceholder}" 
                               Text="{Binding Filter}" 
                               TextChanged="OnSearchTextChanged"
                               BackgroundColor="Transparent"
                               TextColor="{DynamicResource BodyTextColor}"
                               HeightRequest="44"
                               VerticalOptions="Center"
                               Style="{StaticResource AppleEntry}"
                               Margin="0"/>
                        
                        <Button Grid.Column="1"
                                Text="✕"
                                TextColor="{DynamicResource EntryPlaceholderColor}"
                                BackgroundColor="Transparent"
                                Command="{Binding ClearSearchCommand}"
                                IsVisible="{Binding Filter, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                                WidthRequest="30"
                                HeightRequest="30"
                                Padding="0"
                                VerticalOptions="Center"/>
                    </Grid>
                </Border>

                <!-- Add Button -->
                <Button Grid.Column="1" 
                        Text="{x:Static strings:AppResources.ProductsPage_NewProduct}" 
                        Command="{Binding NewCommand}"
                        BackgroundColor="#0A84FF" 
                        TextColor="White" 
                        FontAttributes="Bold" 
                        CornerRadius="12" 
                        HeightRequest="44"
                        VerticalOptions="Center"
                        Padding="20,0">
                    <Button.Behaviors>
                        <behaviors:ButtonMicroAnimationsBehavior />
                    </Button.Behaviors>
                </Button>
            </Grid>

            <!-- LIST -->
            <CollectionView Grid.Row="1" x:Name="ProductsView" ItemsSource="{Binding Filtered}" SelectionMode="None" Margin="0,0,0,20">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Product">
                        <Border StrokeThickness="0"
                                BackgroundColor="{DynamicResource CardBackgroundColor}"
                                StrokeShape="RoundRectangle 12"
                                Padding="16">
                            <Grid ColumnDefinitions="*, Auto, Auto" ColumnSpacing="16">
                                
                                <!-- INFO (Left) -->
                                <VerticalStackLayout Spacing="4" Grid.Column="0" VerticalOptions="Center">
                                    <!-- Name -->
                                    <Label Text="{Binding PRODNOME}" 
                                           FontSize="16" 
                                           FontAttributes="Bold" 
                                           TextColor="{DynamicResource BodyTextColor}"
                                           LineBreakMode="TailTruncation"/>
                                    
                                    <!-- Code -->
                                    <Label Text="{Binding PRODCODIGO}" 
                                           FontSize="14" 
                                           TextColor="{DynamicResource EntryPlaceholderColor}"/>
                                    
                                    <!-- Family & Colaborador -->
                                    <HorizontalStackLayout Spacing="12" Margin="0,4,0,0">
                                        <HorizontalStackLayout Spacing="6" IsVisible="{Binding FAMILIA, Converter={StaticResource IsNotNullOrEmptyConverter}}">
                                            <Label Text="&#xF02C;" FontFamily="FA7Solid" FontSize="12" TextColor="{DynamicResource AccentColor}" VerticalOptions="Center"/>
                                            <Label Text="{Binding FAMILIA}" FontSize="13" TextColor="{DynamicResource BodyTextColor}" VerticalOptions="Center" LineBreakMode="TailTruncation"/>
                                        </HorizontalStackLayout>
                                        
                                        <HorizontalStackLayout Spacing="6" IsVisible="{Binding COLABORADOR, Converter={StaticResource IsNotNullOrEmptyConverter}}">
                                            <Label Text="&#xF007;" FontFamily="FA7Solid" FontSize="12" TextColor="{DynamicResource AccentColor}" VerticalOptions="Center"/>
                                            <Label Text="{Binding COLABORADOR}" FontSize="13" TextColor="{DynamicResource BodyTextColor}" VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                    </HorizontalStackLayout>

                                    <!-- Prices & Totals -->
                                    <HorizontalStackLayout Spacing="16" Margin="0,8,0,0">
                                        <VerticalStackLayout Spacing="2">
                                            <Label Text="{x:Static strings:AppResources.Common_Cost}" FontSize="11" TextColor="{DynamicResource EntryPlaceholderColor}"/>
                                            <Label Text="{Binding PRECOCUSTO, StringFormat='{0:C2}'}" FontSize="13" TextColor="{DynamicResource BodyTextColor}" FontAttributes="Bold"/>
                                        </VerticalStackLayout>
                                        
                                        <VerticalStackLayout Spacing="2">
                                            <Label Text="{x:Static strings:AppResources.Common_Sale}" FontSize="11" TextColor="{DynamicResource EntryPlaceholderColor}"/>
                                            <Label Text="{Binding PRECOVENDA, StringFormat='{0:C2}'}" FontSize="13" TextColor="{DynamicResource BodyTextColor}" FontAttributes="Bold"/>
                                        </VerticalStackLayout>

                                        <VerticalStackLayout Spacing="2">
                                            <Label Text="{x:Static strings:AppResources.Common_TotalSales}" FontSize="11" TextColor="{DynamicResource EntryPlaceholderColor}"/>
                                            <Label Text="{Binding TOTALVENDAS, StringFormat='{0:C2}'}" FontSize="13" TextColor="#10B981" FontAttributes="Bold"/>
                                        </VerticalStackLayout>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <!-- ACTIONS (Right) -->
                                <HorizontalStackLayout Grid.Column="2" Spacing="8" VerticalOptions="Center">
                                    
                                    <!-- Edit -->
                                    <Button Text="&#xF044;" 
                                            FontFamily="FA7Solid" 
                                            FontSize="16"
                                            BackgroundColor="#190A84FF" 
                                            TextColor="#0A84FF"
                                            CornerRadius="8"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Padding="0"
                                            Clicked="OnEditClicked"
                                            CommandParameter="{Binding .}">
                                        <Button.Behaviors>
                                            <behaviors:ButtonMicroAnimationsBehavior />
                                        </Button.Behaviors>
                                    </Button>

                                    <!-- Delete -->
                                    <Button Text="&#xF1F8;" 
                                            FontFamily="FA7Solid" 
                                            FontSize="16"
                                            BackgroundColor="#19FF3B30" 
                                            TextColor="#FF3B30"
                                            CornerRadius="8"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Padding="0"
                                            Clicked="OnDeleteClicked"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding BindingContext.IsFinancial, Source={x:Reference ProductsPageRoot}}">
                                        <Button.Behaviors>
                                        </Button.Behaviors>
                                    </Button>

                                </HorizontalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- EDIT OVERLAY -->
        <Grid x:Name="EditOverlay" 
              IsVisible="{Binding IsEditOverlayVisible}" 
              BackgroundColor="#80000000" 
              ZIndex="999">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseEditCommand}"/>
            </Grid.GestureRecognizers>

            <Border BackgroundColor="{DynamicResource CardBackgroundColor}"
                    StrokeThickness="0"
                    Padding="24"
                    StrokeShape="RoundRectangle 18"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    WidthRequest="800"
                    MaximumHeightRequest="700">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer /> <!-- Prevent close -->
                </Border.GestureRecognizers>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.25" Radius="20" Offset="0,4"/>
                </Border.Shadow>

                <Grid RowDefinitions="Auto, *, Auto" RowSpacing="20">
                    <!-- Header -->
                    <Label Text="{Binding OverlayTitle}" 
                           FontSize="20" 
                           FontAttributes="Bold" 
                           TextColor="{DynamicResource BodyTextColor}"/>

                    <!-- Form -->
                    <ScrollView Grid.Row="1">
                        <VerticalStackLayout Spacing="16">
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                                <VerticalStackLayout Spacing="6" Grid.Column="0">
                                    <Label Text="{x:Static strings:AppResources.Common_Code}" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                    <Entry Style="{StaticResource AppleEntry}" Placeholder="{x:Static strings:AppResources.Common_Code}" Text="{Binding Editing.PRODCODIGO}" IsReadOnly="True" />
                                </VerticalStackLayout>
                                <VerticalStackLayout Spacing="6" Grid.Column="1">
                                    <Label Text="{x:Static strings:AppResources.Common_Collaborator}" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                    <Entry Style="{StaticResource AppleEntry}" Placeholder="{x:Static strings:AppResources.Common_Collaborator}" Text="{Binding Editing.COLABORADOR}" IsReadOnly="True" TextColor="{DynamicResource EntryPlaceholderColor}" />
                                </VerticalStackLayout>
                            </Grid>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                                <VerticalStackLayout Spacing="6" Grid.Column="0">
                                    <Label Text="{x:Static strings:AppResources.ProductsPage_CostPrice}" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                    <Entry Style="{StaticResource AppleEntry}" 
                                           Placeholder="0,00 €" 
                                           Text="{Binding Editing.PRECOCUSTO, Converter={StaticResource CurrencyConverter}}" 
                                           Keyboard="Numeric"
                                           Unfocused="OnPriceUnfocused"/>
                                </VerticalStackLayout>
                                <VerticalStackLayout Spacing="6" Grid.Column="1">
                                    <Label Text="{x:Static strings:AppResources.ProductsPage_SalePrice}" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                    <Entry Style="{StaticResource AppleEntry}" 
                                           Placeholder="0,00 €" 
                                           Text="{Binding Editing.PRECOVENDA, Converter={StaticResource CurrencyConverter}}" 
                                           Keyboard="Numeric"
                                           Unfocused="OnPriceUnfocused"/>
                                </VerticalStackLayout>
                            </Grid>

                            <VerticalStackLayout Spacing="6" ZIndex="100">
                                <Label Text="{x:Static strings:AppResources.Common_Description}" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                <Grid>
                                    <Entry Style="{StaticResource AppleEntry}" 
                                           Placeholder="{x:Static strings:AppResources.ProductsPage_ProductDescriptionPlaceholder}" 
                                           Text="{Binding Editing.PRODNOME}" 
                                           TextChanged="OnDescriptionTextChanged"
                                           VerticalOptions="Start" />
                                    
                                    <!-- Suggestions Dropdown -->
                                    <Border StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0"
                                            BackgroundColor="{DynamicResource CardBackgroundColor}"
                                            IsVisible="{Binding IsSuggestionsVisible}"
                                            VerticalOptions="Start"
                                            Margin="0,60,0,0"
                                            MaximumHeightRequest="200"
                                            ZIndex="999">
                                        <Border.Shadow>
                                            <Shadow Brush="Black" Opacity="0.2" Radius="10" Offset="0,4"/>
                                        </Border.Shadow>
                                        <CollectionView ItemsSource="{Binding DescriptionSuggestions}" SelectionMode="None">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Grid Padding="12,8" ColumnDefinitions="*, Auto">
                                                        <Label Text="{Binding PRODNOME}" TextColor="{DynamicResource BodyTextColor}" VerticalOptions="Center"/>
                                                        <Label Grid.Column="1" Text="{Binding PRODCODIGO}" TextColor="{DynamicResource EntryPlaceholderColor}" FontSize="12" VerticalOptions="Center"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                    </Border>
                                </Grid>
                            </VerticalStackLayout>
                            
                            <VerticalStackLayout Spacing="6">
                                <Label Text="{x:Static strings:AppResources.Common_Family}" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                <Grid ColumnDefinitions="*,Auto">
                                    <Border Grid.Column="0" 
                                            StrokeShape="RoundRectangle 10" 
                                            StrokeThickness="1" 
                                            Stroke="{DynamicResource EntryBorderColor}"
                                            BackgroundColor="{DynamicResource EntryBackgroundColor}" 
                                            HeightRequest="44" 
                                            Padding="12,0">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnFamilyPickerTapped"/>
                                        </Border.GestureRecognizers>
                                        <Grid ColumnDefinitions="*, Auto">
                                            <Label Text="{Binding Editing.FAMILIA, TargetNullValue={x:Static strings:AppResources.ProductsPage_SelectFamily}}" 
                                                   VerticalOptions="Center" 
                                                   TextColor="{DynamicResource BodyTextColor}"
                                                   LineBreakMode="TailTruncation"/>
                                            <Label Grid.Column="1" Text="▼" FontSize="12" TextColor="{DynamicResource EntryPlaceholderColor}" VerticalOptions="Center"/>
                                        </Grid>
                                    </Border>
                                    
                                    <Border Grid.Column="1" Margin="8,0,0,0" WidthRequest="44" HeightRequest="44" StrokeThickness="0" BackgroundColor="#2563EB" StrokeShape="RoundRectangle 10" VerticalOptions="Center">
                                        <Button x:Name="BtnAddFamily" Clicked="OnAddFamilyClicked" BackgroundColor="Transparent" Padding="0" HeightRequest="44" WidthRequest="44" SemanticProperties.Description="{x:Static strings:AppResources.ProductsPage_AddFamily}">
                                            <Button.ImageSource><FontImageSource Glyph="&#xF067;" FontFamily="FA7Solid" Color="White" Size="20"/></Button.ImageSource>
                                        </Button>
                                    </Border>
                                </Grid>
                            </VerticalStackLayout>

                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- Footer Buttons -->
                    <Grid Grid.Row="2" ColumnDefinitions="*, Auto, Auto, Auto" ColumnSpacing="12">
                        
                        <!-- Delete Button (Only visible if not new AND Financial) -->
                        <Button Grid.Column="1"
                                Text="{x:Static strings:AppResources.Common_Delete}"
                                BackgroundColor="#FF3B30"
                                TextColor="White"
                                FontAttributes="Bold"
                                CornerRadius="8"
                                HeightRequest="44"
                                Command="{Binding DeleteEditingCommand}"
                                IsVisible="{Binding CanDelete}"/>

                        <Button Grid.Column="2"
                                Text="{x:Static strings:AppResources.Common_Cancel}" 
                                BackgroundColor="#8E8E93" 
                                TextColor="White" 
                                FontAttributes="Bold"
                                CornerRadius="8"
                                HeightRequest="44"
                                Command="{Binding CloseEditCommand}"/>
                        
                        <Button Grid.Column="3"
                                Text="{Binding SaveButtonText}" 
                                BackgroundColor="#0A84FF" 
                                TextColor="White" 
                                FontAttributes="Bold" 
                                CornerRadius="8"
                                HeightRequest="44"
                                WidthRequest="120"
                                Command="{Binding SaveCommand}"/>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <!-- LIST PICKER OVERLAY -->
        <Grid x:Name="ListPickerOverlay"
              IsVisible="False"
              BackgroundColor="#80000000"
              IgnoreSafeArea="True"
              ZIndex="1001">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnCloseListPickerClicked"/>
            </Grid.GestureRecognizers>

            <Border BackgroundColor="{DynamicResource CardBackgroundColor}"
                    StrokeThickness="0"
                    Padding="20"
                    StrokeShape="RoundRectangle 18"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    WidthRequest="400"
                    HeightRequest="600">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer />
                </Border.GestureRecognizers>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.25" Radius="12" Offset="0,4"/>
                </Border.Shadow>

                <Grid RowDefinitions="Auto,Auto,*,Auto" RowSpacing="15">
                    <Label x:Name="ListPickerTitleLabel"
                           Text="{x:Static strings:AppResources.ProductsPage_SelectFamily}"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="{DynamicResource BodyTextColor}"/>

                    <!-- Search Bar -->
                    <Border Grid.Row="1" 
                            StrokeShape="RoundRectangle 10" 
                            BackgroundColor="{DynamicResource EntryBackgroundColor}"
                            StrokeThickness="0"
                            Padding="8,0">
                        <Grid ColumnDefinitions="*,Auto">
                            <Entry x:Name="ListPickerSearchEntry"
                                   Placeholder="{x:Static strings:AppResources.Common_Search}"
                                   TextChanged="OnListPickerSearchTextChanged"
                                   BackgroundColor="Transparent"
                                   TextColor="{DynamicResource BodyTextColor}"
                                   HeightRequest="36"/>
                            
                            <Button Grid.Column="1"
                                    x:Name="ListPickerClearButton"
                                    Text="✕"
                                    TextColor="{DynamicResource EntryPlaceholderColor}"
                                    BackgroundColor="Transparent"
                                    Clicked="OnListPickerClearSearchClicked"
                                    IsVisible="False"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    Padding="0"/>
                        </Grid>
                    </Border>

                    <CollectionView Grid.Row="2" x:Name="ListPickerCollectionView" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="x:String">
                                <Border StrokeThickness="0" BackgroundColor="Transparent" Padding="12">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnListPickerItemTapped" CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                    <Label Text="{Binding .}" FontSize="16" TextColor="{DynamicResource BodyTextColor}"/>
                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroupList>
                                            <VisualStateGroup x:Name="CommonStates">
                                                <VisualState x:Name="Normal" />
                                                <VisualState x:Name="PointerOver">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="{DynamicResource EntryBackgroundColor}" />
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateGroupList>
                                    </VisualStateManager.VisualStateGroups>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Button Grid.Row="3" 
                            Text="{x:Static strings:AppResources.Common_Close}" 
                            TextColor="#0A84FF"
                            BackgroundColor="Transparent"
                            Clicked="OnCloseListPickerClicked"/>
                </Grid>
            </Border>
        </Grid>

        <!-- Popup Adicionar Família -->
        <Grid x:Name="AddFamilyOverlay" IsVisible="False" BackgroundColor="#66000000" InputTransparent="False" ZIndex="1000">
            <Border StrokeShape="RoundRectangle 18" Background="{DynamicResource CardBackgroundColor}" StrokeThickness="1" Stroke="{DynamicResource DividerColor}" Padding="22" WidthRequest="450" HorizontalOptions="Center" VerticalOptions="Center">
                <VerticalStackLayout Spacing="10">
                    <Label Text="{x:Static strings:AppResources.Family_NewTitle}" FontSize="18" FontAttributes="Bold" TextColor="{DynamicResource BodyTextColor}" HorizontalTextAlignment="Center"/>
                    <Entry x:Name="NewFamilyCodeEntry" Placeholder="{x:Static strings:AppResources.ProductsPage_FamilyCodePlaceholder}" ClearButtonVisibility="WhileEditing" HeightRequest="44"/>
                    <Entry x:Name="NewFamilyNameEntry" Placeholder="{x:Static strings:AppResources.Family_NamePlaceholder}" ClearButtonVisibility="WhileEditing" HeightRequest="44"/>
                    <Label x:Name="AddFamilyErrorLabel" FontSize="12" TextColor="Tomato" IsVisible="False"/>
                    <HorizontalStackLayout Spacing="10" HorizontalOptions="End">
                        <Button x:Name="BtnCancelAddFamily" Text="{x:Static strings:AppResources.Common_Cancel}" Clicked="OnCancelAddFamily" Style="{StaticResource BtnDanger}" ContentLayout="Left,6"><Button.ImageSource><FontImageSource Glyph="&#xF05E;" FontFamily="FA7Solid" Color="White" Size="16"/></Button.ImageSource></Button>
                        <Button x:Name="BtnSaveAddFamily" Text="{x:Static strings:AppResources.Common_Save}" Clicked="OnSaveAddFamily" Style="{StaticResource AppleFilledButton}" ContentLayout="Left,6"><Button.ImageSource><FontImageSource Glyph="&#xF0C7;" FontFamily="FA7Solid" Color="White" Size="16"/></Button.ImageSource></Button>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!-- Busy -->
        <Grid IsVisible="{Binding IsBusy}" BackgroundColor="#66000000" Padding="30" VerticalOptions="Center" HorizontalOptions="Center" ZIndex="1001">
            <ActivityIndicator IsRunning="True" Color="{DynamicResource AppAccent}" />
        </Grid>
    </Grid>
</ContentPage>