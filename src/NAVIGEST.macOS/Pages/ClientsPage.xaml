<?xml version="1.0" encoding="utf-8"?>
<ContentPage x:Class="NAVIGEST.macOS.Pages.ClientsPage"
             x:Name="ClientsPageRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:NAVIGEST.macOS.Models"
             xmlns:behaviors="clr-namespace:NAVIGEST.macOS.Behaviors"
             xmlns:pages="clr-namespace:NAVIGEST.macOS.Pages"
             BackgroundColor="{DynamicResource PageBackgroundColor}"
             Title="Clientes"
             SizeChanged="OnPageSizeChanged"
             Loaded="OnPageLoaded">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Style TargetType="Entry" x:Key="FormEntry">
                <Setter Property="HeightRequest" Value="44"/>
                <Setter Property="FontSize" Value="15"/>
                <Setter Property="Margin" Value="0,4,0,0"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- MAIN CONTENT -->
        <Grid RowDefinitions="Auto, *" 
              Padding="24,24,24,0" 
              RowSpacing="16"
              MaximumWidthRequest="1200"
              HorizontalOptions="Center">
            
            <!-- HEADER: Search & Add -->
            <Grid ColumnDefinitions="*, Auto" ColumnSpacing="16">
                <!-- Search -->
                <Border StrokeShape="RoundRectangle 10" 
                        BackgroundColor="{DynamicResource CardBackgroundColor}"
                        StrokeThickness="0"
                        Padding="8,0"
                        HeightRequest="44"
                        VerticalOptions="Center">
                    <Grid ColumnDefinitions="*,Auto">
                        <Entry Placeholder="Pesquisar (código, nome, email...)" 
                               Text="{Binding Filter}" 
                               BackgroundColor="Transparent"
                               TextColor="{DynamicResource BodyTextColor}"
                               HeightRequest="44"
                               VerticalOptions="Center"
                               Style="{StaticResource AppleEntry}"
                               Margin="0"/>
                        
                        <Button Grid.Column="1"
                                Text="✕"
                                TextColor="{DynamicResource EntryPlaceholderColor}"
                                BackgroundColor="Transparent"
                                Command="{Binding ClearSearchCommand}"
                                IsVisible="{Binding Filter, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                                WidthRequest="30"
                                HeightRequest="30"
                                Padding="0"
                                VerticalOptions="Center"/>
                    </Grid>
                </Border>

                <!-- Add Button -->
                <Button Grid.Column="1" 
                        Text="➕ Novo Cliente" 
                        Command="{Binding NewCommand}"
                        BackgroundColor="#0A84FF" 
                        TextColor="White" 
                        FontAttributes="Bold" 
                        CornerRadius="12" 
                        HeightRequest="44"
                        VerticalOptions="Center"
                        Padding="20,0">
                    <Button.Behaviors>
                        <behaviors:ButtonMicroAnimationsBehavior />
                    </Button.Behaviors>
                </Button>
            </Grid>

            <!-- LIST -->
            <CollectionView Grid.Row="1" x:Name="ClientsView" ItemsSource="{Binding Filtered}" SelectionMode="None" Margin="0,0,0,20">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeThickness="0"
                                BackgroundColor="{DynamicResource CardBackgroundColor}"
                                StrokeShape="RoundRectangle 12"
                                Padding="16">
                            <Grid ColumnDefinitions="*, Auto, Auto" ColumnSpacing="16">
                                
                                <!-- INFO (Left) -->
                                <VerticalStackLayout Spacing="4" Grid.Column="0" VerticalOptions="Center">
                                    <!-- Name -->
                                    <Label Text="{Binding CLINOME}" 
                                           FontSize="16" 
                                           FontAttributes="Bold" 
                                           TextColor="{DynamicResource BodyTextColor}"
                                           LineBreakMode="TailTruncation"/>
                                    
                                    <!-- Code -->
                                    <Label Text="{Binding CLICODIGO}" 
                                           FontSize="14" 
                                           TextColor="{DynamicResource EntryPlaceholderColor}"/>
                                    
                                    <!-- Contact Info (Icon + Text) -->
                                    <HorizontalStackLayout Spacing="12" Margin="0,4,0,0">
                                        <HorizontalStackLayout Spacing="6" IsVisible="{Binding EMAIL, Converter={StaticResource IsNotNullOrEmptyConverter}}">
                                            <Label Text="&#xF0E0;" FontFamily="FA7Solid" FontSize="12" TextColor="{DynamicResource AccentColor}" VerticalOptions="Center"/>
                                            <Label Text="{Binding EMAIL}" FontSize="13" TextColor="{DynamicResource BodyTextColor}" VerticalOptions="Center" LineBreakMode="TailTruncation"/>
                                        </HorizontalStackLayout>
                                        
                                        <HorizontalStackLayout Spacing="6" IsVisible="{Binding TELEFONE, Converter={StaticResource IsNotNullOrEmptyConverter}}">
                                            <Label Text="&#xF095;" FontFamily="FA7Solid" FontSize="12" TextColor="{DynamicResource AccentColor}" VerticalOptions="Center"/>
                                            <Label Text="{Binding TELEFONE}" FontSize="13" TextColor="{DynamicResource BodyTextColor}" VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <!-- STATUS / VALUE (Middle) -->
                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" HorizontalOptions="End" Spacing="4" MinimumWidthRequest="100">
                                    <Label Text="{Binding VALORCREDITO}" 
                                           FontSize="16" 
                                           FontAttributes="Bold" 
                                           TextColor="{DynamicResource BodyTextColor}" 
                                           HorizontalTextAlignment="End"
                                           IsVisible="{Binding BindingContext.IsFinancial, Source={x:Reference ClientsPageRoot}}"/>
                                    
                                    <Border BackgroundColor="{DynamicResource EntryPlaceholderColor}" StrokeThickness="0" StrokeShape="RoundRectangle 4" Padding="6,2" HorizontalOptions="End" IsVisible="{Binding EXTERNO}">
                                        <Label Text="EXTERNO" FontSize="10" TextColor="White" FontAttributes="Bold"/>
                                    </Border>
                                    
                                    <Border BackgroundColor="#FF3B30" StrokeThickness="0" StrokeShape="RoundRectangle 4" Padding="6,2" HorizontalOptions="End" IsVisible="{Binding ANULADO}">
                                        <Label Text="ANULADO" FontSize="10" TextColor="White" FontAttributes="Bold"/>
                                    </Border>
                                </VerticalStackLayout>

                                <!-- ACTIONS (Right) -->
                                <HorizontalStackLayout Grid.Column="2" Spacing="8" VerticalOptions="Center">
                                    
                                    <!-- Edit -->
                                    <Button Text="&#xF044;" 
                                            FontFamily="FA7Solid" 
                                            FontSize="16"
                                            BackgroundColor="#190A84FF" 
                                            TextColor="#0A84FF"
                                            CornerRadius="8"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Padding="0"
                                            Clicked="OnEditClicked"
                                            CommandParameter="{Binding .}">
                                        <Button.Behaviors>
                                            <behaviors:ButtonMicroAnimationsBehavior />
                                        </Button.Behaviors>
                                    </Button>

                                    <!-- Delete -->
                                    <Button Text="&#xF1F8;" 
                                            FontFamily="FA7Solid" 
                                            FontSize="16"
                                            BackgroundColor="#19FF3B30" 
                                            TextColor="#FF3B30"
                                            CornerRadius="8"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Padding="0"
                                            Clicked="OnDeleteClicked"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding BindingContext.IsFinancial, Source={x:Reference ClientsPageRoot}}">
                                        <Button.Behaviors>
                                        </Button.Behaviors>
                                    </Button>

                                    <!-- Folder -->
                                    <Button Text="&#xF07C;" 
                                            FontFamily="FA7Solid" 
                                            FontSize="16"
                                            BackgroundColor="#19FF9500" 
                                            TextColor="#FF9500"
                                            CornerRadius="8"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Padding="0"
                                            Clicked="OnPastasClicked"
                                            CommandParameter="{Binding .}">
                                        <Button.Behaviors>
                                            <behaviors:ButtonMicroAnimationsBehavior />
                                        </Button.Behaviors>
                                    </Button>

                                    <!-- Services -->
                                    <Grid WidthRequest="48" HeightRequest="48">
                                        <Button Text="&#xF085;" 
                                                FontFamily="FA7Solid" 
                                                FontSize="16"
                                                BackgroundColor="#19AF52DE" 
                                                TextColor="#AF52DE"
                                                CornerRadius="8"
                                                WidthRequest="40"
                                                HeightRequest="40"
                                                Padding="0"
                                                VerticalOptions="Center"
                                                HorizontalOptions="Center"
                                                Clicked="OnServicesClicked"
                                                CommandParameter="{Binding .}">
                                            <Button.Behaviors>
                                                <behaviors:ButtonMicroAnimationsBehavior />
                                            </Button.Behaviors>
                                        </Button>

                                        <Border BackgroundColor="#FF3B30" 
                                                StrokeThickness="0"
                                                StrokeShape="RoundRectangle 10"
                                                HeightRequest="20"
                                                MinimumWidthRequest="20"
                                                Padding="4,0"
                                                HorizontalOptions="End"
                                                VerticalOptions="Start"
                                                TranslationX="-2"
                                                TranslationY="2">
                                            <Border.Triggers>
                                                <DataTrigger TargetType="Border" Binding="{Binding ServicesCount}" Value="0">
                                                    <Setter Property="IsVisible" Value="False"/>
                                                </DataTrigger>
                                            </Border.Triggers>
                                            <Label Text="{Binding ServicesCount}" 
                                                   TextColor="White" 
                                                   FontSize="11" 
                                                   FontAttributes="Bold" 
                                                   HorizontalOptions="Center" 
                                                   VerticalOptions="Center"/>
                                        </Border>
                                    </Grid>

                                </HorizontalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- EDIT OVERLAY -->
        <Grid x:Name="EditOverlay" 
              IsVisible="{Binding IsEditOverlayVisible}" 
              BackgroundColor="#80000000" 
              ZIndex="999">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseEditCommand}"/>
            </Grid.GestureRecognizers>

            <Border BackgroundColor="{DynamicResource CardBackgroundColor}"
                    StrokeThickness="0"
                    Padding="24"
                    StrokeShape="RoundRectangle 18"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    WidthRequest="800"
                    MaximumHeightRequest="700">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer /> <!-- Prevent close -->
                </Border.GestureRecognizers>
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.25" Radius="20" Offset="0,4"/>
                </Border.Shadow>

                <Grid RowDefinitions="Auto, *, Auto" RowSpacing="20">
                    <!-- Header -->
                    <Label Text="{Binding Editing.CLINOME, StringFormat='Editar {0}', TargetNullValue='Novo Cliente'}" 
                           FontSize="20" 
                           FontAttributes="Bold" 
                           TextColor="{DynamicResource BodyTextColor}"/>

                    <!-- Form -->
                    <ScrollView Grid.Row="1">
                        <VerticalStackLayout Spacing="16">
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                                <VerticalStackLayout Spacing="6" Grid.Column="0">
                                    <Label Text="Código" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                    <Entry Style="{StaticResource AppleEntry}" Placeholder="Código" Text="{Binding Editing.CLICODIGO}" IsReadOnly="True" />
                                </VerticalStackLayout>
                                <VerticalStackLayout Spacing="6" Grid.Column="1">
                                    <Label Text="Vendedor" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                    <Entry Style="{StaticResource AppleEntry}" Placeholder="Vendedor" Text="{Binding Editing.VENDEDOR}" />
                                </VerticalStackLayout>
                            </Grid>

                            <VerticalStackLayout Spacing="6">
                                <Label Text="Nome" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                <Entry Style="{StaticResource AppleEntry}" Placeholder="Nome do Cliente" Text="{Binding Editing.CLINOME}" />
                            </VerticalStackLayout>
                            
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                                <VerticalStackLayout Spacing="6" Grid.Column="0">
                                                                        <Label Text="Telefone" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                    <Grid ColumnDefinitions="120,*" ColumnSpacing="8">
                                        <Border StrokeShape="RoundRectangle 8" 
                                                StrokeThickness="1" 
                                                Stroke="{DynamicResource EntryBorderColor}"
                                                BackgroundColor="{DynamicResource EntryBackgroundColor}" 
                                                HeightRequest="44" 
                                                Padding="0">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding OpenCountryPickerCommand}"/>
                                            </Border.GestureRecognizers>
                                            <Grid ColumnDefinitions="Auto, *" Padding="8,0">
                                                <Label Text="{Binding SelectedDialCodeItem.FlagEmoji}" 
                                                       VerticalOptions="Center" 
                                                       FontSize="20"
                                                       Margin="0,0,4,0"/>
                                                <Label Grid.Column="1" 
                                                       Text="{Binding SelectedDialCodeItem.NormalizedPrefix}" 
                                                       VerticalOptions="Center"
                                                       TextColor="{DynamicResource BodyTextColor}"
                                                       LineBreakMode="TailTruncation"/>
                                            </Grid>
                                        </Border>
                                        <Entry Grid.Column="1" Style="{StaticResource AppleEntry}" Placeholder="Telefone" Keyboard="Telephone" Text="{Binding PhoneBody}">
                                            <Entry.Behaviors>
                                                <behaviors:EntryValidationBehavior ValidationKind="Phone" />
                                            </Entry.Behaviors>
                                        </Entry>
                                    </Grid>
                                </VerticalStackLayout>
                                <VerticalStackLayout Spacing="6" Grid.Column="1">
                                    <Label Text="Email" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                    <Entry Style="{StaticResource AppleEntry}" Placeholder="Email" Keyboard="Email" Text="{Binding Editing.EMAIL}">
                                        <Entry.Behaviors>
                                            <behaviors:EntryValidationBehavior ValidationKind="Email" />
                                        </Entry.Behaviors>
                                    </Entry>
                                </VerticalStackLayout>
                            </Grid>
                            
                            <VerticalStackLayout Spacing="6" IsVisible="{Binding BindingContext.IsFinancial, Source={x:Reference ClientsPageRoot}}">
                                <Label Text="Valor Crédito" FontSize="13" TextColor="{DynamicResource EntryPlaceholderColor}" Margin="2,0,0,0"/>
                                <Entry x:Name="EntryValorCredito" Style="{StaticResource AppleEntry}" Placeholder="0.00" Text="{Binding Editing.VALORCREDITO}" Focused="OnValorCreditoFocused" Unfocused="OnValorCreditoUnfocused" TextChanged="OnValorCreditoTextChanged">
                                    <Entry.Behaviors>
                                        <behaviors:EntryValidationBehavior ValidationKind="Numeric" />
                                    </Entry.Behaviors>
                                </Entry>
                            </VerticalStackLayout>

                            <FlexLayout Wrap="Wrap" JustifyContent="SpaceBetween" AlignItems="Center" Margin="0,8,0,0">
                                <HorizontalStackLayout Spacing="8" Margin="0,0,16,8">
                                    <Label Text="Externo" VerticalTextAlignment="Center" TextColor="{DynamicResource BodyTextColor}"/>
                                    <Switch IsToggled="{Binding Editing.EXTERNO}" OnColor="{DynamicResource AccentColor}" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Spacing="8" Margin="0,0,16,8">
                                    <Label Text="Anulado" VerticalTextAlignment="Center" TextColor="{DynamicResource BodyTextColor}"/>
                                    <Switch IsToggled="{Binding Editing.ANULADO}" OnColor="{DynamicResource AccentColor}" />
                                </HorizontalStackLayout>
                                
                                <HorizontalStackLayout Spacing="8" Margin="0,0,0,8">
                                    <Label Text="Pastas Sincronizadas" VerticalTextAlignment="Center" TextColor="{DynamicResource BodyTextColor}"/>
                                    <Switch IsToggled="{Binding Editing.PastasSincronizadas}" IsEnabled="False" OnColor="{DynamicResource AccentColor}" />
                                </HorizontalStackLayout>
                            </FlexLayout>
                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- Footer Buttons -->
                    <Grid Grid.Row="2" ColumnDefinitions="*, Auto, Auto, Auto" ColumnSpacing="12">
                        
                        <!-- Delete Button (Only visible if not new AND Financial) -->
                        <Button Grid.Column="1"
                                Text="Eliminar"
                                BackgroundColor="#FF3B30"
                                TextColor="White"
                                FontAttributes="Bold"
                                CornerRadius="8"
                                HeightRequest="44"
                                Command="{Binding DeleteEditingCommand}"
                                IsVisible="{Binding CanDelete}"/>

                        <Button Grid.Column="2"
                                Text="Cancelar" 
                                BackgroundColor="#8E8E93" 
                                TextColor="White" 
                                FontAttributes="Bold"
                                CornerRadius="8"
                                HeightRequest="44"
                                Command="{Binding CloseEditCommand}"/>
                        
                        <Button Grid.Column="3"
                                Text="Atualizar" 
                                BackgroundColor="#0A84FF" 
                                TextColor="White" 
                                FontAttributes="Bold" 
                                CornerRadius="8"
                                HeightRequest="44"
                                WidthRequest="120"
                                Command="{Binding SaveCommand}"/>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <!-- Busy -->
        <Grid IsVisible="{Binding IsBusy}" BackgroundColor="#66000000" Padding="30" VerticalOptions="Center" HorizontalOptions="Center" ZIndex="1000">
            <ActivityIndicator IsRunning="True" Color="{DynamicResource AccentColor}" />
        </Grid>
    </Grid>
</ContentPage>