<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="NAVIGEST.iOS.Pages.MainYahPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:beh="clr-namespace:NAVIGEST.iOS.Behaviors"
    x:Name="Root"
    BackgroundColor="{DynamicResource BodyBg}">

    <ContentPage.Resources>
        <!-- Estilos originais -->
        <Style TargetType="Label" x:Key="TitleText">
            <Setter Property="TextColor" Value="{DynamicResource TopbarFg}" />
            <Setter Property="FontSize" Value="18" />
            <Setter Property="FontAttributes" Value="Bold" />
        </Style>
        <Style TargetType="Label" x:Key="BodyText">
            <Setter Property="TextColor" Value="{DynamicResource BodyFg}" />
            <Setter Property="FontSize" Value="14" />
        </Style>
        <Style TargetType="Label" x:Key="IconLabel">
            <Setter Property="FontFamily" Value="FA7Solid" />
            <Setter Property="FontSize" Value="18" />
            <Setter Property="TextColor" Value="{DynamicResource TopbarFg}" />
            <Setter Property="HorizontalOptions" Value="Start" />
            <Setter Property="VerticalOptions" Value="Center" />
            <Setter Property="Opacity" Value="1" />
            <Setter Property="WidthRequest" Value="24" />
            <Setter Property="HorizontalTextAlignment" Value="Center" />
        </Style>
        <Style TargetType="Label" x:Key="SidebarIconLabel" BasedOn="{StaticResource IconLabel}">
            <Setter Property="TextColor" Value="{DynamicResource SidebarAccent}" />
        </Style>
        <Style TargetType="Label" x:Key="SidebarTextLabel" BasedOn="{StaticResource BodyText}">
            <Setter Property="TextColor" Value="{DynamicResource SidebarAccent}" />
        </Style>
        <Style TargetType="Border" x:Key="MenuItemBorder">
            <Setter Property="Padding" Value="10,8" />
            <Setter Property="BackgroundColor" Value="{DynamicResource SidebarItem}" />
            <Setter Property="StrokeShape">
                <Setter.Value><RoundRectangle CornerRadius="14" /></Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Border" x:Key="TopbarActionBorder">
            <Setter Property="Padding" Value="10,8" />
            <Setter Property="BackgroundColor" Value="Transparent" />
            <Setter Property="StrokeShape">
                <Setter.Value><RoundRectangle CornerRadius="12" /></Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Label" x:Key="TopbarActionIconLabel" BasedOn="{StaticResource IconLabel}">
            <Setter Property="TextColor" Value="{DynamicResource TopbarFg}" />
        </Style>
        <Style TargetType="Label" x:Key="TopbarActionTextLabel" BasedOn="{StaticResource BodyText}">
            <Setter Property="TextColor" Value="{DynamicResource TopbarFg}" />
        </Style>
    </ContentPage.Resources>

    <!-- GRID PRINCIPAL -->
    <Grid RowDefinitions="64,*" ColumnDefinitions="Auto,*">

        <!-- TOPBAR -->
        <Grid Grid.Row="0" Grid.ColumnSpan="2"
              BackgroundColor="{DynamicResource TopbarBg}"
              Padding="10,8"
              x:Name="TopBar">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" /> <!-- Window Controls -->
            </Grid.ColumnDefinitions>

            <!-- Botão hamburguer -->
            <Border Grid.Column="0" Style="{StaticResource TopbarActionBorder}">
                <Grid>
                    <Label Text="&#xF0C9;" Style="{StaticResource TopbarActionIconLabel}" />
                </Grid>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnToggleSidebarTapped" />
                </Border.GestureRecognizers>
            </Border>

            <!-- Logo empresa -->
            <Grid Grid.Column="1" ColumnSpacing="8" Padding="6,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Image Grid.Column="0" Source="{Binding CompanyLogo}" HeightRequest="32" WidthRequest="32" Aspect="AspectFit" />
                <Label Grid.Column="1" Text="{Binding CompanyName}" Style="{StaticResource TitleText}" VerticalTextAlignment="Center" />
            </Grid>

            <!-- Espaço central -->
            <Grid Grid.Column="2" />

            <!-- FOTO UTILIZADOR (apenas desktop) -->
            <Border Grid.Column="3" Padding="0" BackgroundColor="Transparent" HeightRequest="40" WidthRequest="40"
                IsVisible="{OnPlatform Android=false, iOS=false, MacCatalyst=true, WinUI=true}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="999" />
                </Border.StrokeShape>
                <Image Source="{Binding UserPhoto}" HeightRequest="36" WidthRequest="36" Aspect="AspectFill" />
            </Border>

            <!-- Nome + tipo (apenas desktop) -->
            <VerticalStackLayout Grid.Column="4" Spacing="0" Padding="8,0" VerticalOptions="Center"
                IsVisible="{OnPlatform Android=false, iOS=false, MacCatalyst=true, WinUI=true}">
                <Label Text="{Binding UserName}" Style="{StaticResource BodyText}" FontAttributes="Bold"/>
                <Label Text="{Binding UserRole}" Style="{StaticResource BodyText}" FontSize="12" Opacity="0.75"/>
            </VerticalStackLayout>

            <!-- Ações desktop -->
            <HorizontalStackLayout Grid.Column="5" Spacing="8" VerticalOptions="Center"
                                   IsVisible="{OnPlatform Android=false, iOS=false, MacCatalyst=true, WinUI=true}">
                <Border Style="{StaticResource TopbarActionBorder}">
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="&#xF2F5;" Style="{StaticResource TopbarActionIconLabel}" />
                        <Label Text="Logout" Style="{StaticResource TopbarActionTextLabel}" />
                    </HorizontalStackLayout>
                    <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnLogoutTapped" /></Border.GestureRecognizers>
                </Border>
               
            </HorizontalStackLayout>

            <!-- Window Controls (Desktop only) -->
            <HorizontalStackLayout Grid.Column="6" Spacing="0" VerticalOptions="Center"
                                   IsVisible="{OnPlatform Android=false, iOS=false, MacCatalyst=false, WinUI=true}">
                <Border Style="{StaticResource TopbarActionBorder}">
                    <Label Text="&#xF2D1;" Style="{StaticResource TopbarActionIconLabel}" />
                    <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMinimizeClicked" /></Border.GestureRecognizers>
                </Border>
                <Border Style="{StaticResource TopbarActionBorder}">
                    <Label x:Name="MaxRestoreIcon" Text="&#xF2D0;" Style="{StaticResource TopbarActionIconLabel}" />
                    <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMaximizeRestoreClicked" /></Border.GestureRecognizers>
                </Border>
                <Border Style="{StaticResource TopbarActionBorder}">
                    <Label Text="&#xF00D;" Style="{StaticResource TopbarActionIconLabel}" />
                    <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnCloseClicked" /></Border.GestureRecognizers>
                </Border>
            </HorizontalStackLayout>

            <!-- Enable window drag (WinUI only) -->
            <Grid.GestureRecognizers>
                <PanGestureRecognizer PanUpdated="OnTopBarPanUpdated" />
            </Grid.GestureRecognizers>
        </Grid>

        <!-- SIDEBAR DESKTOP -->
        <Border x:Name="Sidebar" Grid.Row="1" BackgroundColor="{DynamicResource SidebarBg}" WidthRequest="{Binding SidebarWidth}" IsVisible="{Binding IsSidebarVisible}">
            <Grid RowDefinitions="*,Auto">
                <!-- Conteúdo rolável -->
                <ScrollView Grid.Row="0">
                    <VerticalStackLayout Padding="10" Spacing="6">
                        <!-- DASHBOARD -->
                        <Border Style="{StaticResource MenuItemBorder}">
                            <Grid ColumnDefinitions="40,*">
                                <Label Text="&#xF015;" Style="{StaticResource SidebarIconLabel}" />
                                <Label Grid.Column="1" Text="Dashboard" Style="{StaticResource SidebarTextLabel}" />
                            </Grid>
                            <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="dashboard" /></Border.GestureRecognizers>
                        </Border>
                        <!-- CLIENTES -->
                        <Border Style="{StaticResource MenuItemBorder}">
                            <Grid ColumnDefinitions="40,*">
                                <Label Text="&#xF0C0;" Style="{StaticResource SidebarIconLabel}" />
                                <Label Grid.Column="1" Text="Clientes" Style="{StaticResource SidebarTextLabel}" />
                            </Grid>
                            <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="clientes" /></Border.GestureRecognizers>
                        </Border>
                        <!-- PRODUTOS -->
                        <Border Style="{StaticResource MenuItemBorder}">
                            <Grid ColumnDefinitions="40,*">
                                <Label Text="&#xF466;" Style="{StaticResource SidebarIconLabel}" />
                                <Label Grid.Column="1" Text="Produtos" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                            </Grid>
                            <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="produtos" /></Border.GestureRecognizers>
                        </Border>
                        <!-- HORAS -->
                        <Border Style="{StaticResource MenuItemBorder}">
                            <Border.Behaviors>
                            </Border.Behaviors>
                            <Grid ColumnDefinitions="40,*">
                                <!-- FA7 Solid: relógio = \uf017 -->
                                <Label Text="&#xF017;" Style="{StaticResource SidebarIconLabel}" />
                                <Label Grid.Column="1" Text="Horas" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                            </Grid>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="horas" />
                            </Border.GestureRecognizers>
                        </Border>
                        <!-- SERVIÇOS -->
                        <Border Style="{StaticResource MenuItemBorder}">
                            <Grid ColumnDefinitions="40,*">
                                <Label Text="&#xF0AD;" Style="{StaticResource SidebarIconLabel}" />
                                <Label Grid.Column="1" Text="Serviços" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                            </Grid>
                            <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="servicos" /></Border.GestureRecognizers>
                        </Border>
                        <!-- CONFIGURAÇÕES (sem expander— já autorizado) -->
                        <Border Style="{StaticResource MenuItemBorder}" IsVisible="{Binding IsAdminUnlocked}">
                            <Grid ColumnDefinitions="50,*">
                                <Label Text="&#xF0C0;" Style="{StaticResource SidebarIconLabel}" />
                                <Label Grid.Column="1" Text="Utilizadores" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                            </Grid>
                            <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="config.utilizadores" /></Border.GestureRecognizers>
                        </Border>
                        <Border Style="{StaticResource MenuItemBorder}" IsVisible="{Binding IsAdminUnlocked}">
                            <Grid ColumnDefinitions="50,*">
                                <Label Text="&#xF1C0;" Style="{StaticResource SidebarIconLabel}" />
                                <Label Grid.Column="1" Text="Ligação BD" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                            </Grid>
                            <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="config.db" /></Border.GestureRecognizers>
                        </Border>
                    </VerticalStackLayout>
                </ScrollView>

                <!-- Rodapé: Tema -->
                <Grid Grid.Row="1" Padding="16,10" RowDefinitions="Auto,Auto" RowSpacing="8">
                    <HorizontalStackLayout Grid.Row="0" Spacing="10" VerticalOptions="Center">
                        <Label x:Name="ThemeModeIcon" FontFamily="FA7Solid" FontSize="18" Text="&#xF185;"
                               TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                        <Label Text="Tema" Style="{StaticResource SidebarTextLabel}" TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                    </HorizontalStackLayout>
                    <Border Grid.Row="1" StrokeThickness="1" Stroke="{DynamicResource SidebarAccent}" BackgroundColor="White" Padding="4,0" StrokeShape="RoundRectangle 10">
                        <Picker x:Name="ThemeModePicker" TitleColor="Black" TextColor="Black" BackgroundColor="Transparent" HeightRequest="30" SelectedIndexChanged="OnThemeModeChanged">
                            <Picker.Items>
                                <x:String>Automático</x:String>
                                <x:String>Claro</x:String>
                                <x:String>Escuro</x:String>
                            </Picker.Items>
                        </Picker>
                    </Border>
                </Grid>
            </Grid>
        </Border>

        <!-- ÁREA DE CONTEÚDO -->
        <Grid Grid.Row="1" Grid.Column="1" BackgroundColor="{DynamicResource BodyBg}">
            <ContentView x:Name="ContentHost">
                <VerticalStackLayout Spacing="6" HorizontalOptions="Center" VerticalOptions="Center">                                    
                    <Label Text="Bem-vindo à:" Style="{StaticResource TitleText}" />                    
                    <Label Text="{Binding CompanyName}" Style="{StaticResource TitleText}" VerticalTextAlignment="Center" />                   
                </VerticalStackLayout>
            </ContentView>
        </Grid>

        <!-- OVERLAY ADMIN -->
        <Grid x:Name="AdminOverlay" Grid.RowSpan="2" Grid.ColumnSpan="2" IsVisible="False" BackgroundColor="#80000000" InputTransparent="False">
            <Border x:Name="AdminCard" BackgroundColor="{DynamicResource BodyBg}" StrokeShape="RoundRectangle 16" Padding="18" HorizontalOptions="Center" VerticalOptions="Center" MaximumWidthRequest="520" Margin="16">
                <VerticalStackLayout Spacing="12">
                    <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                        <Label Text="&#xF023;" Style="{StaticResource TopbarActionIconLabel}" FontSize="20"/>
                        <Label Text="Acesso Administrador" Style="{StaticResource BodyText}" FontSize="18"/>
                    </HorizontalStackLayout>
                    <Grid ColumnDefinitions="28,*" ColumnSpacing="8">
                        <Label Text="&#xF007;" Style="{StaticResource TopbarActionIconLabel}" FontSize="16" VerticalTextAlignment="Center"/>
                        <Entry x:Name="AdminUserEntry" Grid.Column="1" Placeholder="Utilizador" />
                    </Grid>
                    <Grid ColumnDefinitions="28,*,Auto" ColumnSpacing="8">
                        <Label Text="&#xF084;" Style="{StaticResource TopbarActionIconLabel}" FontSize="16" VerticalTextAlignment="Center"/>
                        <Entry x:Name="AdminPassEntry" Grid.Column="1" Placeholder="Palavra-passe" IsPassword="True" />
                        <Button Grid.Column="2" BackgroundColor="Transparent" Padding="8" Clicked="OnAdminTogglePwd">
                            <Button.ImageSource>
                                <FontImageSource x:Name="AdminEyeIcon" Glyph="&#xF06E;" FontFamily="FA7Solid" Color="{DynamicResource BodyFg}" Size="18"/>
                            </Button.ImageSource>
                        </Button>
                    </Grid>
                    <Label x:Name="AdminErrorLabel" IsVisible="False" FontFamily="Inter" FontSize="13" TextColor="{StaticResource Color.Danger}" />
                    <HorizontalStackLayout Spacing="10" HorizontalOptions="End">
                        <Button Text="  Cancelar" Clicked="OnAdminCancel">
                            <Button.ImageSource><FontImageSource Glyph="&#xF00D;" FontFamily="FA7Solid" Size="16" Color="{DynamicResource White}" /></Button.ImageSource>
                        </Button>
                        <Button Text="  OK" Clicked="OnAdminOk">
                            <Button.ImageSource><FontImageSource Glyph="&#xF00C;" FontFamily="FA7Solid" Size="16" Color="{DynamicResource White}" /></Button.ImageSource>
                        </Button>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!-- SIDEBAR OVERLAY ANDROID/IOS (abaixo do topbar, com logo) -->
        <Grid x:Name="SidebarOverlay" Grid.Row="1" Grid.ColumnSpan="2"
              IsVisible="{OnPlatform Android=true, iOS=true, MacCatalyst=false, WinUI=false}"
              BackgroundColor="{DynamicResource SidebarBg}" Opacity="1" TranslationY="-1000"
              HorizontalOptions="Fill" VerticalOptions="Fill">
            <ScrollView>
                <VerticalStackLayout Padding="10" Spacing="6">
                    <!-- LOGO EMPRESA -->
                    <Grid Padding="10" ColumnDefinitions="Auto,*" Margin="0,0,0,10">
                        <Image Grid.Column="0" Source="{Binding CompanyLogo}" HeightRequest="32" WidthRequest="32" Aspect="AspectFit" />
                        <Label Grid.Column="1" Text="{Binding CompanyName}" Style="{StaticResource TitleText}" VerticalTextAlignment="Center" />
                    </Grid>
                    <!-- DASHBOARD -->
                    <Border Style="{StaticResource MenuItemBorder}">
                        <Grid ColumnDefinitions="40,*">
                            <Label Text="&#xF015;" Style="{StaticResource SidebarIconLabel}" />
                            <Label Grid.Column="1" Text="Dashboard" Style="{StaticResource SidebarTextLabel}" />
                        </Grid>
                        <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="dashboard" /></Border.GestureRecognizers>
                    </Border>
                    <!-- CLIENTES -->
                    <Border Style="{StaticResource MenuItemBorder}">
                        <Grid ColumnDefinitions="40,*">
                            <Label Text="&#xF0C0;" Style="{StaticResource SidebarIconLabel}" />
                            <Label Grid.Column="1" Text="Clientes" Style="{StaticResource SidebarTextLabel}" />
                        </Grid>
                        <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="clientes" /></Border.GestureRecognizers>
                    </Border>
                    <!-- PRODUTOS -->
                    <Border Style="{StaticResource MenuItemBorder}">
                        <Grid ColumnDefinitions="40,*">
                            <Label Text="&#xF466;" Style="{StaticResource SidebarIconLabel}" />
                            <Label Grid.Column="1" Text="Produtos" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                        </Grid>
                        <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="produtos" /></Border.GestureRecognizers>
                    </Border>
                    <!-- SERVIÇOS -->
                    <Border Style="{StaticResource MenuItemBorder}">
                        <Grid ColumnDefinitions="40,*">
                            <Label Text="&#xF0AD;" Style="{StaticResource SidebarIconLabel}" />
                            <Label Grid.Column="1" Text="Serviços" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                        </Grid>
                        <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="servicos" /></Border.GestureRecognizers>
                    </Border>
                    <!-- CONFIGURAÇÕES (sem expander— já autorizado) -->
                    <Border Style="{StaticResource MenuItemBorder}" IsVisible="{Binding IsAdminUnlocked}">
                        <Grid ColumnDefinitions="50,*">
                            <Label Text="&#xF0C0;" Style="{StaticResource SidebarIconLabel}" />
                            <Label Grid.Column="1" Text="Utilizadores" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                        </Grid>
                        <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="config.utilizadores" /></Border.GestureRecognizers>
                    </Border>
                    <Border Style="{StaticResource MenuItemBorder}" IsVisible="{Binding IsAdminUnlocked}">
                        <Grid ColumnDefinitions="50,*">
                            <Label Text="&#xF1C0;" Style="{StaticResource SidebarIconLabel}" />
                            <Label Grid.Column="1" Text="Ligação BD" Style="{StaticResource SidebarTextLabel}" IsVisible="{Binding IsSidebarExpanded}" />
                        </Grid>
                        <Border.GestureRecognizers><TapGestureRecognizer Tapped="OnMenuTapped" CommandParameter="config.db" /></Border.GestureRecognizers>
                    </Border>
                </VerticalStackLayout>
            </ScrollView>
            <!-- Rodapé: Tema -->
            <Grid Padding="16,10" RowDefinitions="Auto,Auto" RowSpacing="8" VerticalOptions="End">
                <HorizontalStackLayout Grid.Row="0" Spacing="10" VerticalOptions="Center">
                    <Label x:Name="ThemeModeIconMobile" FontFamily="FA7Solid" FontSize="18" Text="&#xF185;"
                           TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                    <Label Text="Tema" Style="{StaticResource SidebarTextLabel}" TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                </HorizontalStackLayout>
                <Border Grid.Row="1" StrokeThickness="1" Stroke="{DynamicResource SidebarAccent}" BackgroundColor="White" Padding="4,0" StrokeShape="RoundRectangle 10">
                    <Picker x:Name="ThemeModePickerMobile" TitleColor="Black" TextColor="Black" BackgroundColor="White" HeightRequest="40" SelectedIndexChanged="OnThemeModeChangedMobile">
                        <Picker.Items>
                            <x:String>Automático</x:String>
                            <x:String>Claro</x:String>
                            <x:String>Escuro</x:String>
                        </Picker.Items>
                    </Picker>
                </Border>
            </Grid>
        </Grid>

    </Grid>
</ContentPage>