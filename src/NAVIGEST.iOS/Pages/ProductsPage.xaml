<?xml version="1.0" encoding="utf-8"?>
<ContentPage x:Class="NAVIGEST.iOS.Pages.ProductsPage"
             x:Name="ProductsPageRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:NAVIGEST.iOS.Models"
             BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}"
             Title="Produtos">

    <Grid>
        <!-- VIEW 1: Lista -->
        <Grid x:Name="ListViewContainer" RowDefinitions="Auto,*" IsVisible="True">

            <!-- Header -->
            <Grid Padding="16,16,16,12" BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
                <SearchBar x:Name="SearchBar"
                           Placeholder="Pesquisar produtos..."
                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                           BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                           Text="{Binding Filter}"
                           SearchButtonPressed="OnSearchBarSearchButtonPressed"
                           TextChanged="OnSearchBarTextChanged"
                           CancelButtonColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"/>
            </Grid>

            <!-- Lista -->
            <CollectionView Grid.Row="1"
                            x:Name="ProductsCollectionView"
                            ItemsSource="{Binding GroupedProducts}"
                            IsGrouped="True"
                            SelectionMode="None"
                            BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}"
                            Scrolled="OnCollectionViewScrolled">

                <CollectionView.GroupHeaderTemplate>
                    <DataTemplate>
                        <Grid Padding="16,8,16,4" BackgroundColor="Transparent">
                            <Label Text="{Binding Title}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#8E8E93, Dark=#98989F}"/>
                        </Grid>
                    </DataTemplate>
                </CollectionView.GroupHeaderTemplate>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Product">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Reveal" SwipeBehaviorOnInvoked="Close">
                                    <!-- EDITAR -->
                                    <SwipeItemView CommandParameter="{Binding .}" Invoked="OnEditSwipeInvoked">
                                        <Grid WidthRequest="80" Padding="12" BackgroundColor="Transparent">
                                            <Border BackgroundColor="#FFE400"
                                                    WidthRequest="56" HeightRequest="56"
                                                    HorizontalOptions="Center" VerticalOptions="Center"
                                                    StrokeThickness="0">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="28"/>
                                                </Border.StrokeShape>
                                                <Label Text="&#xF044;" FontFamily="FA7Solid" FontSize="22"
                                                       TextColor="#333333" HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Border>
                                        </Grid>
                                    </SwipeItemView>

                                    <!-- ELIMINAR -->
                                    <SwipeItemView CommandParameter="{Binding .}" Invoked="OnDeleteSwipeInvoked">
                                        <Grid WidthRequest="80" Padding="12" BackgroundColor="Transparent">
                                            <Border BackgroundColor="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"
                                                    WidthRequest="56" HeightRequest="56"
                                                    HorizontalOptions="Center" VerticalOptions="Center"
                                                    StrokeThickness="0">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="28"/>
                                                </Border.StrokeShape>
                                                <Label Text="&#xF1F8;" FontFamily="FA7Solid" FontSize="22"
                                                       TextColor="White" HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Border>
                                        </Grid>
                                    </SwipeItemView>
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <!-- Conteúdo do item -->
                            <Grid Padding="16,12"
                                  BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                                  ColumnDefinitions="50,*,Auto"
                                  ColumnSpacing="12"
                                  RowSpacing="4">

                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnProductCellTapped"/>
                                </Grid.GestureRecognizers>

                                <!-- Avatar -->
                                <Border Grid.RowSpan="2" WidthRequest="50" HeightRequest="50"
                                        StrokeThickness="0" BackgroundColor="{Binding AvatarColor}"
                                        VerticalOptions="Center">
                                    <Border.StrokeShape><RoundRectangle CornerRadius="25"/></Border.StrokeShape>
                                    <Label Text="{Binding Initials}"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>

                                <!-- Descrição -->
                                <Label Grid.Column="1"
                                       Text="{Binding Descricao}"
                                       FontSize="17"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       LineBreakMode="TailTruncation"
                                       VerticalOptions="End"/>

                                <!-- Código -->
                                <Label Grid.Column="1" Grid.Row="1"
                                       Text="{Binding Codigo}"
                                       FontSize="14"
                                       TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                                       LineBreakMode="TailTruncation"
                                       VerticalOptions="Start"/>

                                <!-- Preço -->
                                <Label Grid.Column="2" Grid.RowSpan="2"
                                       Text="{Binding ValorDisplay}"
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                                       VerticalOptions="Center"
                                       HorizontalOptions="End"/>

                                <!-- Separador -->
                                <BoxView Grid.ColumnSpan="3" Grid.Row="1" HeightRequest="0.5"
                                         Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                         VerticalOptions="End" Margin="62,0,0,0"/>
                            </Grid>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- FAB -->
            <Border Grid.Row="1"
                    WidthRequest="56" HeightRequest="56"
                    BackgroundColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                    StrokeThickness="0"
                    Margin="0,0,16,16"
                    HorizontalOptions="End"
                    VerticalOptions="End">
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.3" Radius="8" Offset="0,4"/>
                </Border.Shadow>
                <Border.StrokeShape><RoundRectangle CornerRadius="28"/></Border.StrokeShape>
                <Label FontFamily="FA7Solid" Text="&#xF067;" FontSize="24" TextColor="White"
                       HorizontalOptions="Center" VerticalOptions="Center"/>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnAddProductTapped"/>
                </Border.GestureRecognizers>
            </Border>

            <!-- Busy -->
            <Grid Grid.RowSpan="2" IsVisible="{Binding IsBusy}" BackgroundColor="#66000000">
                <ActivityIndicator IsRunning="True"
                                   Color="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                                   WidthRequest="40" HeightRequest="40"/>
            </Grid>
        </Grid>

        <!-- VIEW 2: Form -->
        <Grid x:Name="FormViewContainer" IsVisible="False"
              BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
            <ScrollView>
                <VerticalStackLayout Spacing="20" Padding="16">

                    <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,8,0,0">
                        <Button Grid.Column="0" Text="Cancelar"
                                Style="{StaticResource AppleTextButton}" Clicked="OnCancelEditTapped"/>
                        <Label Grid.Column="1" x:Name="FormTitle" Text="Novo Produto"
                               FontSize="17" FontAttributes="Bold"
                               HorizontalOptions="Center" VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                    </Grid>

                    <Border StrokeShape="RoundRectangle 10"
                            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                            Stroke="Transparent" Padding="0">
                        <VerticalStackLayout Spacing="0">
                            <Grid Padding="16,12" ColumnDefinitions="110,*">
                                <Label Text="Código" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                                <Entry Grid.Column="1" x:Name="CodigoEntry" Text="{Binding Editing.Codigo}" IsReadOnly="True"
                                       BackgroundColor="Transparent" TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}" HorizontalTextAlignment="End"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

                            <Grid Padding="16,12" ColumnDefinitions="110,*">
                                <Label Text="Descrição" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                                <Entry Grid.Column="1" x:Name="DescricaoEntry" Text="{Binding Editing.Descricao}"
                                       BackgroundColor="Transparent" HorizontalTextAlignment="End" Placeholder="Nome do produto"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

                            <Grid Padding="16,12" ColumnDefinitions="110,*">
                                <Label Text="Família" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                                <Picker Grid.Column="1" x:Name="FamiliaPicker"
                                        ItemsSource="{Binding Families}"
                                        SelectedItem="{Binding Editing.FamiliaSelecionada}"
                                        Title="Selecionar família"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

                            <Grid Padding="16,12" ColumnDefinitions="110,*">
                                <Label Text="Colaborador" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                                <Entry Grid.Column="1" x:Name="ColaboradorEntry" Text="{Binding Editing.Colaborador}"
                                       BackgroundColor="Transparent" HorizontalTextAlignment="End" Placeholder="Nome do colaborador"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

                            <Grid Padding="16,12" ColumnDefinitions="110,*">
                                <Label Text="Preço de custo" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                                <Entry Grid.Column="1" x:Name="PrecoCustoEntry" Text="{Binding Editing.Valor}" Keyboard="Numeric"
                                       BackgroundColor="Transparent" HorizontalTextAlignment="End" Placeholder="0,00"
                                       Focused="OnPrecoCustoFocused" Unfocused="OnPrecoCustoUnfocused"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <VerticalStackLayout Spacing="12">
                        <Button x:Name="SaveButton" Text="Guardar" Style="{StaticResource AppleFilledButton}"
                                Clicked="OnSaveProductTapped">
                            <Button.ImageSource>
                                <FontImageSource Glyph="&#xF0C7;" FontFamily="FA7Solid" Size="16" Color="White"/>
                            </Button.ImageSource>
                        </Button>

                        <Button x:Name="DeleteFormButton" Text="Eliminar Produto" Style="{StaticResource AppleTintedButton}"
                                TextColor="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}" IsVisible="False"
                                Clicked="OnDeleteFromFormTapped">
                            <Button.ImageSource>
                                <FontImageSource Glyph="&#xF1F8;" FontFamily="FA7Solid" Size="16"
                                                 Color="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"/>
                            </Button.ImageSource>
                        </Button>
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </Grid>
    </Grid>
</ContentPage>
