<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:NAVIGEST.iOS.Converters"
             xmlns:beh="clr-namespace:NAVIGEST.iOS.Behaviors"
             x:Class="NAVIGEST.iOS.Pages.RegisterPage"
             BackgroundColor="{DynamicResource PageBackgroundColor}"
             Title="Utilizadores">

    <ContentPage.Resources>
        <conv:BytesToImageSourceConverter x:Key="BytesToImage"/>
    </ContentPage.Resources>

    <Grid>
        <!-- Main Content -->
        <ScrollView x:Name="MainScrollView">
            <VerticalStackLayout Spacing="0" Padding="0">
                
                <!-- Header with buttons -->
                <Grid Padding="16,16,16,12" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12"
                      BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
                    <Button Grid.Column="0" 
                            Text="â† Lista" 
                            Style="{StaticResource AppleTintedButton}"
                            Clicked="OnOpenUserPicker"
                            Padding="12,8"/>
                    
                    <Label Grid.Column="1" 
                           Text="Lista de Utilizadores"
                           FontSize="20"
                           FontAttributes="Bold"
                           VerticalOptions="Center"
                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                    
                    <Button Grid.Column="2"
                            Text="+ Novo"
                            Style="{StaticResource AppleFilledButton}"
                            Clicked="OnNovoClicked"
                            Padding="12,8"/>
                </Grid>

                <!-- Avatar Section -->
                <Grid Padding="0,24,0,24" 
                      BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}">
                    <VerticalStackLayout Spacing="16" HorizontalOptions="Center">
                        <!-- Avatar Circle -->
                        <Border StrokeShape="RoundRectangle 60"
                                WidthRequest="120"
                                HeightRequest="120"
                                Stroke="{AppThemeBinding Light=#E5E5EA, Dark=#38383A}"
                                StrokeThickness="0"
                                BackgroundColor="{AppThemeBinding Light=#E5E5EA, Dark=#3A3A3C}"
                                HorizontalOptions="Center">
                            <Grid>
                                <Label x:Name="UserIcon"
                                       FontFamily="FA7Solid"
                                       Text="&#xF007;"
                                       FontSize="64"
                                       TextColor="{AppThemeBinding Light=#C7C7CC, Dark=#8E8E93}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       IsVisible="True"/>
                                <Image x:Name="UserImage" 
                                       IsVisible="False" 
                                       Aspect="AspectFill">
                                    <Image.Clip>
                                        <EllipseGeometry Center="60,60" RadiusX="60" RadiusY="60"/>
                                    </Image.Clip>
                                </Image>
                            </Grid>
                        </Border>
                        
                        <!-- Change Photo Button -->
                        <Button Text="Alterar Foto"
                                Style="{StaticResource AppleTextButton}"
                                Clicked="OnEscolherImagemClicked"/>
                    </VerticalStackLayout>
                </Grid>

                <!-- Form Fields in Grouped Style (iOS Settings-like) -->
                <VerticalStackLayout Spacing="32" Padding="16,8,16,24"
                                   BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
                    
                    <!-- Account Info Group -->
                    <VerticalStackLayout Spacing="2">
                        <Border StrokeShape="RoundRectangle 10"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                                Stroke="Transparent">
                            <VerticalStackLayout Spacing="0">
                                <!-- Username -->
                                <Grid Padding="16,12" ColumnDefinitions="120,*" MinimumHeightRequest="44">
                                    <Label Text="Username" 
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                    <Entry Grid.Column="1"
                                           x:Name="entryUsername"
                                           Placeholder="utilizador"
                                           Background="Transparent"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                                
                                <BoxView HeightRequest="0.5" 
                                        Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                        Margin="16,0"/>
                                
                                <!-- Password -->
                                <Grid Padding="16,12" ColumnDefinitions="120,*" MinimumHeightRequest="44">
                                    <Label Text="Palavra-passe" 
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                    <Entry Grid.Column="1"
                                           x:Name="entryPassword"
                                           Placeholder="********"
                                           IsPassword="True"
                                           Background="Transparent"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                            </VerticalStackLayout>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Personal Info Group -->
                    <VerticalStackLayout Spacing="2">
                        <Border StrokeShape="RoundRectangle 10"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                                Stroke="Transparent">
                            <VerticalStackLayout Spacing="0">
                                <!-- Name -->
                                <Grid Padding="16,12" ColumnDefinitions="120,*" MinimumHeightRequest="44">
                                    <Label Text="Nome completo" 
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                    <Entry Grid.Column="1"
                                           x:Name="entryName"
                                           Placeholder="Nome"
                                           Background="Transparent"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                                
                                <BoxView HeightRequest="0.5" 
                                        Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                        Margin="16,0"/>
                                
                                <!-- Contact -->
                                <Grid Padding="16,12" ColumnDefinitions="120,*" MinimumHeightRequest="44">
                                    <Label Text="Contacto" 
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                    <Entry Grid.Column="1"
                                           x:Name="entryContact"
                                           Placeholder="912345678"
                                           Keyboard="Telephone"
                                           Background="Transparent"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                                
                                <BoxView HeightRequest="0.5" 
                                        Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                        Margin="16,0"/>
                                
                                <!-- Email -->
                                <Grid Padding="16,12" ColumnDefinitions="120,*" MinimumHeightRequest="44">
                                    <Label Text="Email" 
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                    <Entry Grid.Column="1"
                                           x:Name="entryEmail"
                                           Placeholder="email@exemplo.com"
                                           Keyboard="Email"
                                           Background="Transparent"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                            </VerticalStackLayout>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Categories Group -->
                    <VerticalStackLayout Spacing="2">
                        <Border StrokeShape="RoundRectangle 10"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                                Stroke="Transparent">
                            <VerticalStackLayout Spacing="0">
                                <!-- Categoria 1 -->
                                <Grid Padding="16,12" ColumnDefinitions="120,*" MinimumHeightRequest="44">
                                    <Label Text="Categoria 1" 
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                    <Entry Grid.Column="1"
                                           x:Name="entryCategoria1"
                                           Placeholder="Categoria 1"
                                           Background="Transparent"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                                
                                <BoxView HeightRequest="0.5" 
                                        Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                        Margin="16,0"/>
                                
                                <!-- Categoria 2 -->
                                <Grid Padding="16,12" ColumnDefinitions="120,*" MinimumHeightRequest="44">
                                    <Label Text="Categoria 2" 
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                    <Entry Grid.Column="1"
                                           x:Name="entryCategoria2"
                                           Placeholder="Categoria 2"
                                           Background="Transparent"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                                
                                <BoxView HeightRequest="0.5" 
                                        Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                        Margin="16,0"/>
                                
                                <!-- Tipo Utilizador -->
                                <Grid Padding="16,12" ColumnDefinitions="120,*" MinimumHeightRequest="44">
                                    <Label Text="Tipo de utilizador" 
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                    <Entry Grid.Column="1"
                                           x:Name="entryTipo"
                                           Placeholder="Tipo"
                                           Background="Transparent"
                                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                            </VerticalStackLayout>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Action Buttons -->
                    <VerticalStackLayout Spacing="12">
                        <Button Text="ðŸ’¾ Guardar"
                                Style="{StaticResource AppleFilledButton}"
                                Clicked="OnGuardarClicked"/>
                        
                        <Button Text="âœï¸ Atualizar"
                                BackgroundColor="{AppThemeBinding Light=#FF9500, Dark=#FF9F0A}"
                                TextColor="White"
                                FontSize="17"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                HeightRequest="50"
                                Clicked="OnAtualizarClicked"/>
                        
                        <Button Text="ðŸ—‘ï¸ Eliminar"
                                BackgroundColor="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"
                                TextColor="White"
                                FontSize="17"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                HeightRequest="50"
                                Clicked="OnEliminarClicked"/>
                        
                        <Button Text="ðŸ§¹ Limpar"
                                Style="{StaticResource AppleTintedButton}"
                                Clicked="OnNovoClicked"/>
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

        <!-- User Picker Overlay -->
        <Grid x:Name="UserPickerOverlay" IsVisible="False" BackgroundColor="#80000000">
            <Border StrokeShape="RoundRectangle 18" 
                    Background="{DynamicResource CardBackgroundColor}" 
                    StrokeThickness="1" 
                    Stroke="{DynamicResource DividerColor}" 
                    Padding="18" 
                    Margin="16" 
                    HorizontalOptions="Fill" 
                    VerticalOptions="Center" 
                    MaximumHeightRequest="700">
                <Grid RowDefinitions="Auto,*,Auto" RowSpacing="12">
                    <Label Text="Selecionar Utilizador" 
                           FontAttributes="Bold" 
                           FontSize="18"
                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                    
                    <CollectionView Grid.Row="1" 
                                    x:Name="UsersPickerView"
                                    SelectionMode="Single" 
                                    SelectionChanged="OnUserPickerSelectionChanged">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="12" ColumnDefinitions="60,*,Auto" ColumnSpacing="12">
                                    <!-- Avatar -->
                                    <Border StrokeShape="RoundRectangle 20"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Stroke="Transparent"
                                            BackgroundColor="{AppThemeBinding Light=#E5E5EA, Dark=#3A3A3C}">
                                        <Image WidthRequest="40" 
                                               HeightRequest="40"
                                               Aspect="AspectFill"
                                               Source="{Binding ProfilePicture, Converter={StaticResource BytesToImage}}">
                                            <Image.Clip>
                                                <EllipseGeometry Center="20,20" RadiusX="20" RadiusY="20"/>
                                            </Image.Clip>
                                        </Image>
                                    </Border>
                                    
                                    <!-- Name & Email -->
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                        <Label Text="{Binding Name}" 
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                                        <Label Text="{Binding Email}" 
                                               FontSize="13"
                                               TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                    </VerticalStackLayout>
                                    
                                    <!-- Tipo -->
                                    <Label Grid.Column="2" 
                                           Text="{Binding TipoUtilizador}" 
                                           FontSize="13"
                                           VerticalOptions="Center"
                                           TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    
                    <Button Grid.Row="2" 
                            Text="Fechar" 
                            Clicked="OnCloseUserPicker" 
                            Style="{StaticResource AppleTintedButton}"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
