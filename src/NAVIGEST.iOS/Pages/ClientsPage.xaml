<?xml version="1.0" encoding="utf-8"?>
<ContentPage x:Class="NAVIGEST.iOS.Pages.ClientsPage"
             x:Name="ClientsPageRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:NAVIGEST.iOS.Models"
             xmlns:behaviors="clr-namespace:NAVIGEST.iOS.Behaviors"
             BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}"
             Title="Clientes">

    <Grid RowDefinitions="Auto,*">
        
        <!-- Header com SearchBar -->
        <Grid Padding="16,16,16,12" BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
            <SearchBar x:Name="SearchBar"
                       Placeholder="Pesquisar clientes..."
                       PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                       BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                       Text="{Binding Filter}"/>
        </Grid>

        <!-- CollectionView com swipe -->
        <CollectionView Grid.Row="1"
                        x:Name="ClientsCollectionView"
                        ItemsSource="{Binding Filtered}"
                        SelectionMode="Single"
                        SelectionChanged="OnClientSelectionChanged"
                        BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
            
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Cliente">
                    <SwipeView>
                        <!-- Swipe Actions (esquerda para direita) -->
                        <SwipeView.RightItems>
                            <SwipeItems Mode="Reveal">
                                <!-- Botão Editar (laranja) -->
                                <SwipeItemView>
                                    <Grid BackgroundColor="#FF9500" 
                                          WidthRequest="80"
                                          Padding="0">
                                        <VerticalStackLayout VerticalOptions="Center" 
                                                           HorizontalOptions="Center"
                                                           Spacing="4">
                                            <Label FontFamily="FA7Solid" 
                                                   Text="&#xF044;" 
                                                   FontSize="20"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"/>
                                            <Label Text="Editar" 
                                                   FontSize="12"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"/>
                                        </VerticalStackLayout>
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnEditClientTapped" 
                                                                CommandParameter="{Binding .}"/>
                                        </Grid.GestureRecognizers>
                                    </Grid>
                                </SwipeItemView>
                                
                                <!-- Botão Eliminar (vermelho) -->
                                <SwipeItemView>
                                    <Grid BackgroundColor="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}" 
                                          WidthRequest="80"
                                          Padding="0">
                                        <VerticalStackLayout VerticalOptions="Center" 
                                                           HorizontalOptions="Center"
                                                           Spacing="4">
                                            <Label FontFamily="FA7Solid" 
                                                   Text="&#xF1F8;" 
                                                   FontSize="20"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"/>
                                            <Label Text="Eliminar" 
                                                   FontSize="12"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"/>
                                        </VerticalStackLayout>
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnDeleteClientTapped" 
                                                                CommandParameter="{Binding .}"/>
                                        </Grid.GestureRecognizers>
                                    </Grid>
                                </SwipeItemView>
                            </SwipeItems>
                        </SwipeView.RightItems>

                        <!-- Conteúdo da célula -->
                        <Grid Padding="16,12" 
                              BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                              ColumnDefinitions="50,*,Auto" 
                              ColumnSpacing="12"
                              RowSpacing="4">
                            
                            <!-- Avatar -->
                            <Border Grid.RowSpan="2"
                                    WidthRequest="50" 
                                    HeightRequest="50"
                                    StrokeThickness="0"
                                    BackgroundColor="{Binding AvatarColor}"
                                    VerticalOptions="Center">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="25"/>
                                </Border.StrokeShape>
                                <Label Text="{Binding Initials}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Border>

                            <!-- Nome -->
                            <Label Grid.Column="1"
                                   Text="{Binding CLINOME}"
                                   FontSize="17"
                                   FontAttributes="None"
                                   TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                   LineBreakMode="TailTruncation"
                                   VerticalOptions="End"/>

                            <!-- Telefone -->
                            <Label Grid.Column="1" 
                                   Grid.Row="1"
                                   Text="{Binding TELEFONE}"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                                   LineBreakMode="TailTruncation"
                                   VerticalOptions="Start"/>

                            <!-- Status Icon (direita) -->
                            <Label Grid.Column="2"
                                   Grid.RowSpan="2"
                                   FontFamily="FA7Solid"
                                   Text="{Binding StatusIcon}"
                                   FontSize="16"
                                   TextColor="{Binding StatusColor}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="End"/>
                            
                            <!-- Separador inferior -->
                            <BoxView Grid.ColumnSpan="3"
                                     Grid.Row="1"
                                     HeightRequest="0.5"
                                     Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                     VerticalOptions="End"
                                     Margin="62,0,0,0"/>
                            
                            <!-- Visual State para seleção -->
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal"/>
                                    <VisualState Name="Selected">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" 
                                                    Value="{AppThemeBinding Light=#E0F2FE, Dark=#204454}"/>
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Grid>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Floating Action Button (adicionar cliente) -->
        <Border Grid.Row="1"
                WidthRequest="56"
                HeightRequest="56"
                BackgroundColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                StrokeThickness="0"
                Margin="0,0,16,16"
                HorizontalOptions="End"
                VerticalOptions="End">
            <Border.Shadow>
                <Shadow Brush="Black" Opacity="0.3" Radius="8" Offset="0,4"/>
            </Border.Shadow>
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="28"/>
            </Border.StrokeShape>
            <Label FontFamily="FA7Solid"
                   Text="&#xF067;"
                   FontSize="24"
                   TextColor="White"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"/>
            <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnAddClientTapped"/>
            </Border.GestureRecognizers>
        </Border>

        <!-- Busy Indicator -->
        <Grid Grid.RowSpan="2"
              IsVisible="{Binding IsBusy}" 
              BackgroundColor="#66000000">
            <ActivityIndicator IsRunning="True" 
                             Color="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                             WidthRequest="40"
                             HeightRequest="40"/>
        </Grid>
    </Grid>
</ContentPage>

