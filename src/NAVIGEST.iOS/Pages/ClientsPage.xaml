<?xml version="1.0" encoding="utf-8"?>
<ContentPage x:Class="NAVIGEST.iOS.Pages.ClientsPage"
             x:Name="ClientsPageRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:NAVIGEST.iOS.Models"
             xmlns:local="clr-namespace:NAVIGEST.iOS.Pages"
             xmlns:behaviors="clr-namespace:NAVIGEST.iOS.Behaviors"
             xmlns:converters="clr-namespace:NAVIGEST.iOS.Converters"
             BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}"
             Title="Clientes">

  <ContentPage.Resources>
    <ResourceDictionary>
      <converters:ValidationStateToColorConverter x:Key="ValidationStateToColorConverter" />
    </ResourceDictionary>
  </ContentPage.Resources>

  <Grid>
    <!-- VIEW 1: Lista -->
    <Grid x:Name="ListViewContainer" RowDefinitions="Auto,*" IsVisible="True">

      <!-- Header -->
      <Grid Padding="16,16,16,12" BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
        <SearchBar x:Name="SearchBar"
                   Placeholder="Pesquisar clientes..."
                   PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                   TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                   BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                   Text="{Binding Filter}"
                   SearchButtonPressed="OnSearchBarSearchButtonPressed"
                   TextChanged="OnSearchBarTextChanged"
                   CancelButtonColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"/>
      </Grid>

  <!-- Lista -->
  <RefreshView Grid.Row="1"
       Command="{Binding RefreshCommand}"
       IsRefreshing="{Binding IsRefreshing}">
    <CollectionView x:Name="ClientsCollectionView"
        ItemsSource="{Binding Filtered}"
        SelectionMode="None"
        BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}"
        Scrolled="OnCollectionViewScrolled">

        <CollectionView.ItemTemplate>
          <DataTemplate x:DataType="models:Cliente">
            <!-- SwipeView com Buttons circulares -->
            <SwipeView>
              <SwipeView.RightItems>
                <SwipeItems Mode="Reveal" SwipeBehaviorOnInvoked="Close">

                  <!-- PASTAS -->
                  <SwipeItemView>
                    <Button Text="&#xF07C;"
                            FontFamily="FA7Solid"
                            FontSize="22"
                            TextColor="White"
                            WidthRequest="60"
                            HeightRequest="60"
                            Padding="0"
                            BackgroundColor="#34C759"
                            CornerRadius="30"
                            CommandParameter="{Binding .}"
                            Clicked="OnPastasButtonClicked"/>
                  </SwipeItemView>

                  <!-- ELIMINAR -->
                  <SwipeItemView>
                    <Button Text="&#xF1F8;"
                            FontFamily="FA7Solid"
                            FontSize="22"
                            TextColor="White"
                            WidthRequest="60"
                            HeightRequest="60"
                            Padding="0"
                            BackgroundColor="#FF3B30"
                            CornerRadius="30"
                            CommandParameter="{Binding .}"
                            Clicked="OnDeleteButtonClicked"/>
                  </SwipeItemView>

                  <!-- EDITAR - Circular Button -->
                  <SwipeItemView Command="{Binding Source={RelativeSource AncestorType={x:Type local:ClientsPage}}, Path=BindingContext.SelectCommand}"
                                CommandParameter="{Binding .}"
                                Invoked="OnSwipeItemViewEditInvoked">
                    <Button Text="&#xF044;" 
                            FontFamily="FA7Solid" 
                            FontSize="24" 
                            TextColor="White"
                            WidthRequest="60"
                            HeightRequest="60"
                            Padding="0"
                            BackgroundColor="#5AC8FA"
                            CornerRadius="30"/>
                  </SwipeItemView>

                </SwipeItems>
              </SwipeView.RightItems>

              <!-- Conteúdo do item -->
              <Grid Padding="16,12"
                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                    ColumnDefinitions="50,*,Auto"
                    ColumnSpacing="12"
                    RowSpacing="4">
                <Grid.GestureRecognizers>
                  <TapGestureRecognizer Tapped="OnClientCellTapped"/>
                </Grid.GestureRecognizers>

                <!-- Avatar -->
                <Border Grid.RowSpan="2" WidthRequest="50" HeightRequest="50"
                        StrokeThickness="0" BackgroundColor="{Binding AvatarColor}"
                        VerticalOptions="Center">
                  <Border.StrokeShape><RoundRectangle CornerRadius="25"/></Border.StrokeShape>
                  <Label Text="{Binding Initials}" FontSize="20" FontAttributes="Bold"
                         TextColor="White" HorizontalOptions="Center" VerticalOptions="Center"/>
                </Border>

                <!-- Nome -->
                <Label Grid.Column="1"
                       Text="{Binding CLINOME}"
                       FontSize="17"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                       LineBreakMode="TailTruncation"
                       VerticalOptions="End"/>

                <!-- Telefone -->
      <Label Grid.Column="1" Grid.Row="1"
        Text="{Binding TelefoneDisplay}"
                       FontSize="14"
                       TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                       LineBreakMode="TailTruncation"
                       VerticalOptions="Start"/>

                <!-- Status -->
                <Label Grid.Column="2" Grid.RowSpan="2"
                       FontFamily="FA7Solid"
                       Text="{Binding StatusIcon}"
                       FontSize="16"
                       TextColor="{Binding StatusColor}"
                       VerticalOptions="Center"
                       HorizontalOptions="End"/>

                <!-- Separador -->
                <BoxView Grid.ColumnSpan="3" Grid.Row="1" HeightRequest="0.5"
                         Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                         VerticalOptions="End" Margin="62,0,0,0"/>
              </Grid>
            </SwipeView>
          </DataTemplate>
        </CollectionView.ItemTemplate>
        </CollectionView>
      </RefreshView>

      <!-- FAB -->
      <Border Grid.Row="1"
              WidthRequest="56" HeightRequest="56"
              BackgroundColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
              StrokeThickness="0"
              Margin="0,0,16,16"
              HorizontalOptions="End"
              VerticalOptions="End">
        <Border.Shadow>
          <Shadow Brush="Black" Opacity="0.3" Radius="8" Offset="0,4"/>
        </Border.Shadow>
        <Border.StrokeShape><RoundRectangle CornerRadius="28"/></Border.StrokeShape>
        <Label FontFamily="FA7Solid" Text="&#xF067;" FontSize="24" TextColor="White"
               HorizontalOptions="Center" VerticalOptions="Center"/>
        <Border.GestureRecognizers>
          <TapGestureRecognizer Tapped="OnAddClientTapped"/>
        </Border.GestureRecognizers>
      </Border>

      <!-- Busy -->
      <Grid Grid.RowSpan="2" IsVisible="{Binding IsBusy}" BackgroundColor="#66000000">
        <ActivityIndicator IsRunning="True"
                           Color="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                           WidthRequest="40" HeightRequest="40"/>
      </Grid>
    </Grid>

    <!-- VIEW 2: Form -->
    <Grid x:Name="FormViewContainer" IsVisible="False"
          BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
      <ScrollView>
        <ScrollView.GestureRecognizers>
          <TapGestureRecognizer Tapped="OnFormBackgroundTapped" NumberOfTapsRequired="1"/>
        </ScrollView.GestureRecognizers>
        <VerticalStackLayout Spacing="20" Padding="16">

          <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,8,0,0">
            <Button Grid.Column="0" Text="Cancelar"
                    Style="{StaticResource AppleTextButton}" Clicked="OnCancelEditTapped"/>
            <Label Grid.Column="1" x:Name="FormTitle" Text="Novo Cliente"
                   FontSize="17" FontAttributes="Bold"
                   HorizontalOptions="Center" VerticalOptions="Center"
                   TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
          </Grid>

          <Border StrokeShape="RoundRectangle 10"
                  BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                  Stroke="Transparent" Padding="0">
            <VerticalStackLayout Spacing="0">
              <Grid Padding="16,12" ColumnDefinitions="100,*">
                <Label Text="Código" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                <Entry Grid.Column="1" x:Name="CodigoEntry" Text="{Binding Editing.CLICODIGO}" IsReadOnly="True"
                       BackgroundColor="Transparent" TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}" HorizontalTextAlignment="End"/>
              </Grid>
              <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

              <Grid Padding="16,12" ColumnDefinitions="100,*">
                <Label Text="Nome" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                <Entry Grid.Column="1" x:Name="NomeEntry" Text="{Binding Editing.CLINOME}"
                       BackgroundColor="Transparent" HorizontalTextAlignment="End" Placeholder="Nome completo"/>
              </Grid>
              <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

              <Grid Padding="16,12" ColumnDefinitions="100,*">
                <Label Text="Telefone" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                <Grid Grid.Column="1" RowDefinitions="Auto,2" ColumnDefinitions="Auto,*" ColumnSpacing="12">
                  <Picker x:Name="DialCodePicker"
                          ItemsSource="{Binding DialCodes}"
                          SelectedItem="{Binding SelectedDialCodeItem}"
                          ItemDisplayBinding="{Binding PickerDisplay}"
                          HorizontalOptions="Start"
                          VerticalOptions="Center"
                          WidthRequest="110"
                          BackgroundColor="Transparent"
                          TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                          Title="Indicativo"/>
                  <Entry Grid.Column="1" x:Name="TelefoneEntry" Text="{Binding PhoneBody}" Keyboard="Telephone"
                         BackgroundColor="Transparent" HorizontalTextAlignment="Start" Placeholder="916 000 000">
                    <Entry.Behaviors>
                      <behaviors:EntryValidationBehavior ValidationKind="Phone" />
                    </Entry.Behaviors>
                  </Entry>
                  <BoxView Grid.Row="1" Grid.ColumnSpan="2" HeightRequest="2"
                           Color="{Binding Source={x:Reference TelefoneEntry}, Path=(behaviors:EntryValidation.State), Converter={StaticResource ValidationStateToColorConverter}}"
                           HorizontalOptions="Fill"
                           VerticalOptions="End" />
                </Grid>
              </Grid>
              <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

              <Grid Padding="16,12" ColumnDefinitions="100,*">
                <Label Text="Email" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                <Grid Grid.Column="1" RowDefinitions="Auto,2">
                  <Entry x:Name="EmailEntry" Text="{Binding Editing.EMAIL}" Keyboard="Email"
                         BackgroundColor="Transparent" HorizontalTextAlignment="End" Placeholder="email@exemplo.com">
                    <Entry.Behaviors>
                      <behaviors:EntryValidationBehavior ValidationKind="Email" />
                    </Entry.Behaviors>
                  </Entry>
                  <BoxView Grid.Row="1" HeightRequest="2"
                           Color="{Binding Source={x:Reference EmailEntry}, Path=(behaviors:EntryValidation.State), Converter={StaticResource ValidationStateToColorConverter}}"
                           HorizontalOptions="Fill"
                           VerticalOptions="End" />
                </Grid>
              </Grid>
              <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

              <Grid Padding="16,12" ColumnDefinitions="100,*">
                <Label Text="Vendedor" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                <Grid Grid.Column="1" ColumnDefinitions="Auto,*" ColumnSpacing="12">
                  <Button x:Name="AddVendedorButton"
                          WidthRequest="40"
                          HeightRequest="40"
                          Padding="0"
                          BackgroundColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                          CornerRadius="20"
                          Clicked="OnAddVendedorTapped">
                    <Button.Shadow>
                      <Shadow Brush="Black" Opacity="0.25" Radius="6" Offset="0,2"/>
                    </Button.Shadow>
                    <Button.ImageSource>
                      <FontImageSource Glyph="&#xF067;" FontFamily="FA7Solid" Size="18" Color="White"/>
                    </Button.ImageSource>
                  </Button>
                  <Picker Grid.Column="1"
                          x:Name="VendedorPicker"
                          ItemsSource="{Binding Vendedores}"
                          SelectedItem="{Binding SelectedVendedor}"
                          ItemDisplayBinding="{Binding Nome}"
                          Title="Selecionar vendedor"
                          BackgroundColor="Transparent"
                          TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                </Grid>
              </Grid>
              <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>

              <Grid Padding="16,12" ColumnDefinitions="100,*">
                <Label Text="Valor Crédito" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
      <Entry Grid.Column="1" x:Name="ValorCreditoEntry" Text="{Binding Editing.VALORCREDITO}" Keyboard="Numeric"
        BackgroundColor="Transparent" HorizontalTextAlignment="End" Placeholder="0,00"
        Focused="OnValorCreditoFocused" Unfocused="OnValorCreditoUnfocused"/>
              </Grid>
            </VerticalStackLayout>
          </Border>

          <Border StrokeShape="RoundRectangle 10"
                  BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                  Stroke="Transparent" Padding="0">
            <VerticalStackLayout Spacing="0">
              <Grid Padding="16,12" ColumnDefinitions="*,Auto">
                <Label Text="Cliente Externo" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                <Switch Grid.Column="1" x:Name="ExternoSwitch" IsToggled="{Binding Editing.EXTERNO, Mode=TwoWay}"/>
              </Grid>
              <BoxView HeightRequest="0.5" Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}" Margin="16,0,0,0"/>
              <Grid Padding="16,12" ColumnDefinitions="*,Auto">
                <Label Text="Anulado" TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" VerticalOptions="Center"/>
                <Switch Grid.Column="1" x:Name="AnuladoSwitch" IsToggled="{Binding Editing.ANULADO, Mode=TwoWay}"/>
              </Grid>
            </VerticalStackLayout>
          </Border>

          <VerticalStackLayout Spacing="12">
            <Button x:Name="SaveButton" Text="Guardar" Style="{StaticResource AppleFilledButton}"
                    Clicked="OnSaveClientTapped">
              <Button.ImageSource>
                <FontImageSource Glyph="&#xF0C7;" FontFamily="FA7Solid" Size="16" Color="White"/>
              </Button.ImageSource>
            </Button>

            <Grid ColumnDefinitions="*,*" ColumnSpacing="8" IsVisible="False" x:Name="ActionButtonsGrid">
              <Button Grid.Column="0" x:Name="PastasFormButton" Text="Pastas" Style="{StaticResource AppleTintedButton}"
                      TextColor="#5AC8FA"
                      Clicked="OnPastasFormTapped">
                <Button.ImageSource>
                  <FontImageSource Glyph="&#xF07C;" FontFamily="FA7Solid" Size="16" Color="#5AC8FA"/>
                </Button.ImageSource>
              </Button>

              <Button Grid.Column="1" x:Name="DeleteFormButton" Text="Eliminar" Style="{StaticResource AppleTintedButton}"
                      TextColor="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"
                      Clicked="OnDeleteFromFormTapped">
                <Button.ImageSource>
                  <FontImageSource Glyph="&#xF1F8;" FontFamily="FA7Solid" Size="16"
                                   Color="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"/>
                </Button.ImageSource>
              </Button>
            </Grid>
          </VerticalStackLayout>

        </VerticalStackLayout>
      </ScrollView>
    </Grid>
  </Grid>
</ContentPage>
