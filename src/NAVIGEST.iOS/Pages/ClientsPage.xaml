<?xml version="1.0" encoding="utf-8"?>
<ContentPage x:Class="NAVIGEST.iOS.Pages.ClientsPage"
             x:Name="ClientsPageRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:NAVIGEST.iOS.Pages"
             xmlns:models="clr-namespace:NAVIGEST.iOS.Models"
             xmlns:behaviors="clr-namespace:NAVIGEST.iOS.Behaviors"
             BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}"
             Title="Clientes">

    <Grid>
        <!-- VIEW 1: Lista de Clientes -->
        <Grid x:Name="ListViewContainer" RowDefinitions="Auto,*" IsVisible="True">
            
            <!-- Header com SearchBar -->
            <Grid Padding="16,16,16,12" BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
                <SearchBar x:Name="SearchBar"
                           Placeholder="Pesquisar clientes..."
                           PlaceholderColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                           BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                           Text="{Binding Filter}"
                           SearchButtonPressed="OnSearchBarSearchButtonPressed"
                           TextChanged="OnSearchBarTextChanged"
                           CancelButtonColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"/>
            </Grid>

            <!-- CollectionView com swipe -->
            <CollectionView Grid.Row="1"
                            x:Name="ClientsCollectionView"
                            ItemsSource="{Binding Filtered}"
                            SelectionMode="None"
                            BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}"
                            Scrolled="OnCollectionViewScrolled">
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Cliente">
                        <SwipeView x:Name="ClientSwipeView">
                            <!-- Swipe Actions (deslizar para esquerda) -->
                            <SwipeView.RightItems>
                                <!-- Fecha SEMPRE quando uma ação é invocada -->
                                <SwipeItems Mode="Reveal" SwipeBehaviorOnInvoked="Close">

                                    <!-- PASTAS -->
                                    <SwipeItemView BindingContext="{Binding .}"
                                                   Invoked="OnPastasSwipeInvoked">
                                        <Grid BackgroundColor="Transparent" WidthRequest="80" Padding="15,12">
                                            <Grid WidthRequest="56" HeightRequest="56"
                                                  HorizontalOptions="Center" VerticalOptions="Center">
                                                <BoxView Color="#00D9FF" CornerRadius="28" 
                                                         WidthRequest="56" HeightRequest="56"/>
                                                <Label FontFamily="FA7Solid" Text="&#xF07C;" FontSize="24"
                                                       TextColor="White" 
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Grid>
                                    </SwipeItemView>

                                    <!-- ELIMINAR -->
                                    <SwipeItemView BindingContext="{Binding .}"
                                                   Invoked="OnDeleteSwipeInvoked">
                                        <Grid BackgroundColor="Transparent" WidthRequest="80" Padding="15,12">
                                            <Grid WidthRequest="56" HeightRequest="56"
                                                  HorizontalOptions="Center" VerticalOptions="Center">
                                                <BoxView Color="#FF006E" CornerRadius="28" 
                                                         WidthRequest="56" HeightRequest="56"/>
                                                <Label FontFamily="FA7Solid" Text="&#xF1F8;" FontSize="24"
                                                       TextColor="White" 
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Grid>
                                    </SwipeItemView>

                                    <!-- EDITAR -->
                                    <SwipeItemView BindingContext="{Binding .}"
                                                   Invoked="OnEditSwipeInvoked">
                                        <Grid BackgroundColor="Transparent" WidthRequest="80" Padding="15,12">
                                            <Grid WidthRequest="56" HeightRequest="56"
                                                  HorizontalOptions="Center" VerticalOptions="Center">
                                                <BoxView Color="#FFE400" CornerRadius="28" 
                                                         WidthRequest="56" HeightRequest="56"/>
                                                <Label FontFamily="FA7Solid" Text="&#xF044;" FontSize="24"
                                                       TextColor="#333333" 
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Grid>
                                    </SwipeItemView>

                                </SwipeItems>
                            </SwipeView.RightItems>

                            <!-- Conteúdo da célula -->
                            <Grid Padding="16,12" 
                                  BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                                  ColumnDefinitions="50,*,Auto" 
                                  ColumnSpacing="12"
                                  RowSpacing="4">
                                
                                <!-- TapGestureRecognizer para abrir formulário de edição -->
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnClientCellTapped"/>
                                </Grid.GestureRecognizers>
                                
                                <!-- Avatar -->
                                <Border Grid.RowSpan="2"
                                        WidthRequest="50" 
                                        HeightRequest="50"
                                        StrokeThickness="0"
                                        BackgroundColor="{Binding AvatarColor}"
                                        VerticalOptions="Center">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="25"/>
                                    </Border.StrokeShape>
                                    <Label Text="{Binding Initials}"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>

                                <!-- Nome -->
                                <Label Grid.Column="1"
                                       Text="{Binding CLINOME}"
                                       FontSize="17"
                                       FontAttributes="None"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       LineBreakMode="TailTruncation"
                                       VerticalOptions="End"/>

                                <!-- Telefone -->
                                <Label Grid.Column="1" 
                                       Grid.Row="1"
                                       Text="{Binding TELEFONE}"
                                       FontSize="14"
                                       TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                                       LineBreakMode="TailTruncation"
                                       VerticalOptions="Start"/>

                                <!-- Status Icon (direita) -->
                                <Label Grid.Column="2"
                                       Grid.RowSpan="2"
                                       FontFamily="FA7Solid"
                                       Text="{Binding StatusIcon}"
                                       FontSize="16"
                                       TextColor="{Binding StatusColor}"
                                       VerticalOptions="Center"
                                       HorizontalOptions="End"/>
                                
                                <!-- Separador inferior -->
                                <BoxView Grid.ColumnSpan="3"
                                         Grid.Row="1"
                                         HeightRequest="0.5"
                                         Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                         VerticalOptions="End"
                                         Margin="62,0,0,0"/>
                            </Grid>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Floating Action Button (adicionar cliente) -->
            <Border Grid.Row="1"
                    WidthRequest="56"
                    HeightRequest="56"
                    BackgroundColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                    StrokeThickness="0"
                    Margin="0,0,16,16"
                    HorizontalOptions="End"
                    VerticalOptions="End">
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.3" Radius="8" Offset="0,4"/>
                </Border.Shadow>
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="28"/>
                </Border.StrokeShape>
                <Label FontFamily="FA7Solid"
                       Text="&#xF067;"
                       FontSize="24"
                       TextColor="White"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"/>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnAddClientTapped"/>
                </Border.GestureRecognizers>
            </Border>

            <!-- Busy Indicator (lista) -->
            <Grid Grid.RowSpan="2"
                  IsVisible="{Binding IsBusy}" 
                  BackgroundColor="#66000000">
                <ActivityIndicator IsRunning="True" 
                                   Color="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
                                   WidthRequest="40"
                                   HeightRequest="40"/>
            </Grid>
        </Grid>

        <!-- VIEW 2: Formulário de Edição/Criação -->
        <Grid x:Name="FormViewContainer" IsVisible="False" BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#000000}">
            <ScrollView>
                <VerticalStackLayout Spacing="20" Padding="16">
                    
                    <!-- Header -->
                    <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,8,0,0">
                        <Button Grid.Column="0" 
                                Text="Cancelar"
                                Style="{StaticResource AppleTextButton}"
                                Clicked="OnCancelEditTapped"/>
                        <Label Grid.Column="1"
                               x:Name="FormTitle"
                               Text="Novo Cliente"
                               FontSize="17"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"/>
                    </Grid>

                    <!-- Formulário iOS Style -->
                    <Border StrokeShape="RoundRectangle 10"
                            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                            Stroke="Transparent"
                            Padding="0">
                        <VerticalStackLayout Spacing="0">
                            
                            <!-- Código (readonly) -->
                            <Grid Padding="16,12" ColumnDefinitions="100,*">
                                <Label Text="Código"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       VerticalOptions="Center"/>
                                <Entry Grid.Column="1"
                                       x:Name="CodigoEntry"
                                       Text="{Binding Editing.CLICODIGO}"
                                       IsReadOnly="True"
                                       BackgroundColor="Transparent"
                                       TextColor="{AppThemeBinding Light=#8E8E93, Dark=#8E8E93}"
                                       HorizontalTextAlignment="End"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" 
                                     Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                     Margin="16,0,0,0"/>
                            
                            <!-- Nome -->
                            <Grid Padding="16,12" ColumnDefinitions="100,*">
                                <Label Text="Nome"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       VerticalOptions="Center"/>
                                <Entry Grid.Column="1"
                                       x:Name="NomeEntry"
                                       Text="{Binding Editing.CLINOME}"
                                       BackgroundColor="Transparent"
                                       HorizontalTextAlignment="End"
                                       Placeholder="Nome completo"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" 
                                     Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                     Margin="16,0,0,0"/>
                            
                            <!-- Telefone -->
                            <Grid Padding="16,12" ColumnDefinitions="100,*">
                                <Label Text="Telefone"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       VerticalOptions="Center"/>
                                <Entry Grid.Column="1"
                                       x:Name="TelefoneEntry"
                                       Text="{Binding Editing.TELEFONE}"
                                       Keyboard="Telephone"
                                       BackgroundColor="Transparent"
                                       HorizontalTextAlignment="End"
                                       Placeholder="916 000 000"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" 
                                     Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                     Margin="16,0,0,0"/>
                            
                            <!-- Email -->
                            <Grid Padding="16,12" ColumnDefinitions="100,*">
                                <Label Text="Email"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       VerticalOptions="Center"/>
                                <Entry Grid.Column="1"
                                       x:Name="EmailEntry"
                                       Text="{Binding Editing.EMAIL}"
                                       Keyboard="Email"
                                       BackgroundColor="Transparent"
                                       HorizontalTextAlignment="End"
                                       Placeholder="email@exemplo.com"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" 
                                     Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                     Margin="16,0,0,0"/>
                            
                            <!-- Vendedor -->
                            <Grid Padding="16,12" ColumnDefinitions="100,*">
                                <Label Text="Vendedor"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       VerticalOptions="Center"/>
                                <Entry Grid.Column="1"
                                       x:Name="VendedorEntry"
                                       Text="{Binding Editing.VENDEDOR}"
                                       BackgroundColor="Transparent"
                                       HorizontalTextAlignment="End"
                                       Placeholder="Nome vendedor"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" 
                                     Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                     Margin="16,0,0,0"/>
                            
                            <!-- Valor Crédito -->
                            <Grid Padding="16,12" ColumnDefinitions="100,*">
                                <Label Text="Valor Crédito"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       VerticalOptions="Center"/>
                                <Entry Grid.Column="1"
                                       x:Name="ValorCreditoEntry"
                                       Text="{Binding Editing.VALORCREDITO}"
                                       Keyboard="Numeric"
                                       BackgroundColor="Transparent"
                                       HorizontalTextAlignment="End"
                                       Placeholder="0,00"/>
                            </Grid>
                            
                        </VerticalStackLayout>
                    </Border>

                    <!-- Switches -->
                    <Border StrokeShape="RoundRectangle 10"
                            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1C1C1E}"
                            Stroke="Transparent"
                            Padding="0">
                        <VerticalStackLayout Spacing="0">
                            
                            <Grid Padding="16,12" ColumnDefinitions="*,Auto">
                                <Label Text="Cliente Externo"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       VerticalOptions="Center"/>
                                <Switch Grid.Column="1"
                                        x:Name="ExternoSwitch"
                                        IsToggled="{Binding Editing.EXTERNO, Mode=TwoWay}"/>
                            </Grid>
                            <BoxView HeightRequest="0.5" 
                                     Color="{AppThemeBinding Light=#C6C6C8, Dark=#38383A}"
                                     Margin="16,0,0,0"/>
                            
                            <Grid Padding="16,12" ColumnDefinitions="*,Auto">
                                <Label Text="Anulado"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}"
                                       VerticalOptions="Center"/>
                                <Switch Grid.Column="1"
                                        x:Name="AnuladoSwitch"
                                        IsToggled="{Binding Editing.ANULADO, Mode=TwoWay}"/>
                            </Grid>
                            
                        </VerticalStackLayout>
                    </Border>

                    <!-- Botões de Ação -->
                    <VerticalStackLayout Spacing="12">
                        <Button x:Name="SaveButton"
                                Text="Guardar"
                                Style="{StaticResource AppleFilledButton}"
                                Clicked="OnSaveClientTapped">
                            <Button.ImageSource>
                                <FontImageSource Glyph="&#xF0C7;" 
                                                 FontFamily="FA7Solid" 
                                                 Size="16"
                                                 Color="White"/>
                            </Button.ImageSource>
                        </Button>
                        
                        <Button x:Name="DeleteFormButton"
                                Text="Eliminar Cliente"
                                Style="{StaticResource AppleTintedButton}"
                                TextColor="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"
                                IsVisible="False"
                                Clicked="OnDeleteFromFormTapped">
                            <Button.ImageSource>
                                <FontImageSource Glyph="&#xF1F8;" 
                                                 FontFamily="FA7Solid" 
                                                 Size="16"
                                                 Color="{AppThemeBinding Light=#FF3B30, Dark=#FF453A}"/>
                            </Button.ImageSource>
                        </Button>
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </Grid>

    </Grid>
</ContentPage>
